<!DOCTYPE html>
<html lang="en-us">
<head>
  <link rel="preload" href="/lib/font-awesome/webfonts/fa-brands-400.woff2" as="font" type="font/woff2" crossorigin="anonymous">
  <link rel="preload" href="/lib/font-awesome/webfonts/fa-regular-400.woff2" as="font" type="font/woff2" crossorigin="anonymous">
  <link rel="preload" href="/lib/font-awesome/webfonts/fa-solid-900.woff2" as="font" type="font/woff2" crossorigin="anonymous">
  <link rel="preload" href="/lib/JetBrainsMono/web/woff2/JetBrainsMono-Regular.woff2" as="font" type="font/woff2" crossorigin="anonymous">
  <script type="text/javascript" src="https://latest.cactus.chat/cactus.js"></script>
  <link rel="stylesheet" href="https://latest.cactus.chat/style.css" type="text/css">
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <title> 使用kubeadm初始化集群 | Cactus theme example</title>
  <link rel = 'canonical' href = 'https://example.com/posts/create-cluster-use-kubeadm/'>
  <meta name="description" content="随便记录点东西">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <meta name="robots" content="all,follow">
  <meta name="googlebot" content="index,follow,snippet,archive">
  <meta property="og:title" content="使用kubeadm初始化集群" />
<meta property="og:description" content="很久之前就写过这篇笔记，一直没发出来，虽说这样的文章差不多已经烂大街了，还是可以看一下的。
1⎈⎈ 2apt install -y bash-completion 3yum install -y bash-completion 4echo &#34;source &lt;(kubectl completion bash)&#34; &gt;&gt; ~/.bashrc 5echo &#34;source &lt;(kubeadm completion bash)&#34; &gt;&gt; ~/.bashrc 6source ~/.bashrc 7modprobe ip_vs &amp;&amp; modprobe ip_vs_rr &amp;&amp; modprobe ip_vs_wrr &amp;&amp; modprobe ip_vs_sh 8rm -rf /var/lib/cni/ 9rm -rf /var/lib/kubelet/* 10rm -rf /etc/cni/ 11ip link del cni0 &amp;&amp; ip link del flannel.1 &amp;&amp; ip link del kube-ipvs0 12net.ipv6.conf.all.disable_ipv6 = 1 13awk &#39;$2 ~ path {print $2}&#39; path=/var/lib/kubelet /proc/mounts | xargs -r umount 14kubeadm init --kubernetes-version 1." />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://example.com/posts/create-cluster-use-kubeadm/" />
<meta property="article:published_time" content="2019-05-17T22:31:20+08:00" />
<meta property="article:modified_time" content="2019-05-17T22:31:20+08:00" />

  <meta name="twitter:card" content="summary"/>
<meta name="twitter:title" content="使用kubeadm初始化集群"/>
<meta name="twitter:description" content="很久之前就写过这篇笔记，一直没发出来，虽说这样的文章差不多已经烂大街了，还是可以看一下的。
1⎈⎈ 2apt install -y bash-completion 3yum install -y bash-completion 4echo &#34;source &lt;(kubectl completion bash)&#34; &gt;&gt; ~/.bashrc 5echo &#34;source &lt;(kubeadm completion bash)&#34; &gt;&gt; ~/.bashrc 6source ~/.bashrc 7modprobe ip_vs &amp;&amp; modprobe ip_vs_rr &amp;&amp; modprobe ip_vs_wrr &amp;&amp; modprobe ip_vs_sh 8rm -rf /var/lib/cni/ 9rm -rf /var/lib/kubelet/* 10rm -rf /etc/cni/ 11ip link del cni0 &amp;&amp; ip link del flannel.1 &amp;&amp; ip link del kube-ipvs0 12net.ipv6.conf.all.disable_ipv6 = 1 13awk &#39;$2 ~ path {print $2}&#39; path=/var/lib/kubelet /proc/mounts | xargs -r umount 14kubeadm init --kubernetes-version 1."/>

  
  
    
  
  
  <link rel="stylesheet" href="https://example.com/css/styles.b7d947e05a1170a37e8b82db035a37baf568e98c7fcbe3f9dd31eac5e6a72150f9f731721fa60a1b3eed4c6a9db9c5a706d396767b698198aeea1614f88ce960.css" integrity="sha512-t9lH4FoRcKN&#43;i4LbA1o3uvVo6Yx/y&#43;P53THqxeanIVD59zFyH6YKGz7tTGqducWnBtOWdntpgZiu6hYU&#43;IzpYA=="> 

  
  
  
    <!--[if lt IE 9]>
      <script src="https://oss.maxcdn.com/html5shiv/3.7.2/html5shiv.min.js"></script>
      <script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
    <![endif]-->
  

  
<link rel="icon" type="image/png" href="https://example.com/images/favicon.ico" />

  
  
  
  
</head>

<body class="max-width mx-auto px3 ltr">
  <div class="content index py4">

  <div id="header-post">
  <a id="menu-icon" href="#"><i class="fas fa-bars fa-lg"></i></a>
  <a id="menu-icon-tablet" href="#"><i class="fas fa-bars fa-lg"></i></a>
  <a id="top-icon-tablet" href="#" onclick="$('html, body').animate({ scrollTop: 0 }, 'fast');" style="display:none;" aria-label="Top of Page"><i class="fas fa-chevron-up fa-lg"></i></a>
  <span id="menu">
    <span id="nav">
      <ul>
         
        <li><a href="/">Home</a></li>
         
        <li><a href="/posts">Writings</a></li>
         
        <li><a href="/tags">Tags</a></li>
         
        <li><a href="/about">About</a></li>
        
      </ul>
    </span>
    <br/>
    <span id="actions">
      <ul>
        
        <li>
          <a class="icon" href=" https://example.com/posts/storage-in-kubernets/" aria-label="Previous">
            <i class="fas fa-chevron-left" aria-hidden="true" onmouseover="$('#i-prev').toggle();" onmouseout="$('#i-prev').toggle();"></i>
          </a>
        </li>
        
        
        <li>
          <a class="icon" href="https://example.com/posts/k8s-apiserver-webhook/" aria-label="Next">
            <i class="fas fa-chevron-right" aria-hidden="true" onmouseover="$('#i-next').toggle();" onmouseout="$('#i-next').toggle();"></i>
          </a>
        </li>
        
        <li>
          <a class="icon" href="#" onclick="$('html, body').animate({ scrollTop: 0 }, 'fast');" aria-label="Top of Page">
            <i class="fas fa-chevron-up" aria-hidden="true" onmouseover="$('#i-top').toggle();" onmouseout="$('#i-top').toggle();"></i>
          </a>
        </li>
        <li>
          <a class="icon" href="#" aria-label="Share">
            <i class="fas fa-share-alt" aria-hidden="true" onmouseover="$('#i-share').toggle();" onmouseout="$('#i-share').toggle();" onclick="$('#share').toggle();return false;"></i>
          </a>
        </li>
      </ul>
      <span id="i-prev" class="info" style="display:none;">Previous post</span>
      <span id="i-next" class="info" style="display:none;">Next post</span>
      <span id="i-top" class="info" style="display:none;">Back to top</span>
      <span id="i-share" class="info" style="display:none;">Share post</span>
    </span>
    <br/>
    <div id="share" style="display: none">
      
      <ul>
  
  
    
  
  
  <li>
    <a class="icon" href="http://www.facebook.com/sharer.php?u=https%3a%2f%2fexample.com%2fposts%2fcreate-cluster-use-kubeadm%2f" aria-label="Facebook">
      <i class="fab fa-facebook " aria-hidden="true"></i>
    </a>
  </li>
  <li>
    <a class="icon" href="https://twitter.com/share?url=https%3a%2f%2fexample.com%2fposts%2fcreate-cluster-use-kubeadm%2f&text=%e4%bd%bf%e7%94%a8kubeadm%e5%88%9d%e5%a7%8b%e5%8c%96%e9%9b%86%e7%be%a4" aria-label="Twitter">
      <i class="fab fa-twitter " aria-hidden="true"></i>
    </a>
  </li>
  <li>
    <a class="icon" href="http://www.linkedin.com/shareArticle?url=https%3a%2f%2fexample.com%2fposts%2fcreate-cluster-use-kubeadm%2f&title=%e4%bd%bf%e7%94%a8kubeadm%e5%88%9d%e5%a7%8b%e5%8c%96%e9%9b%86%e7%be%a4" aria-label="Linkedin">
      <i class="fab fa-linkedin " aria-hidden="true"></i>
    </a>
  </li>
  <li>
    <a class="icon" href="https://pinterest.com/pin/create/bookmarklet/?url=https%3a%2f%2fexample.com%2fposts%2fcreate-cluster-use-kubeadm%2f&is_video=false&description=%e4%bd%bf%e7%94%a8kubeadm%e5%88%9d%e5%a7%8b%e5%8c%96%e9%9b%86%e7%be%a4" aria-label="Pinterest">
      <i class="fab fa-pinterest " aria-hidden="true"></i>
    </a>
  </li>
  <li>
    <a class="icon" href="mailto:?subject=%e4%bd%bf%e7%94%a8kubeadm%e5%88%9d%e5%a7%8b%e5%8c%96%e9%9b%86%e7%be%a4&body=Check out this article: https%3a%2f%2fexample.com%2fposts%2fcreate-cluster-use-kubeadm%2f" aria-label="Email">
      <i class="fas fa-envelope " aria-hidden="true"></i>
    </a>
  </li>
  <li>
    <a class="icon" href="https://getpocket.com/save?url=https%3a%2f%2fexample.com%2fposts%2fcreate-cluster-use-kubeadm%2f&title=%e4%bd%bf%e7%94%a8kubeadm%e5%88%9d%e5%a7%8b%e5%8c%96%e9%9b%86%e7%be%a4" aria-label="Pocket">
      <i class="fab fa-get-pocket " aria-hidden="true"></i>
    </a>
  </li>
  <li>
    <a class="icon" href="http://reddit.com/submit?url=https%3a%2f%2fexample.com%2fposts%2fcreate-cluster-use-kubeadm%2f&title=%e4%bd%bf%e7%94%a8kubeadm%e5%88%9d%e5%a7%8b%e5%8c%96%e9%9b%86%e7%be%a4" aria-label="reddit">
      <i class="fab fa-reddit " aria-hidden="true"></i>
    </a>
  </li>
  <li>
    <a class="icon" href="http://www.tumblr.com/share/link?url=https%3a%2f%2fexample.com%2fposts%2fcreate-cluster-use-kubeadm%2f&name=%e4%bd%bf%e7%94%a8kubeadm%e5%88%9d%e5%a7%8b%e5%8c%96%e9%9b%86%e7%be%a4&description=%e5%be%88%e4%b9%85%e4%b9%8b%e5%89%8d%e5%b0%b1%e5%86%99%e8%bf%87%e8%bf%99%e7%af%87%e7%ac%94%e8%ae%b0%ef%bc%8c%e4%b8%80%e7%9b%b4%e6%b2%a1%e5%8f%91%e5%87%ba%e6%9d%a5%ef%bc%8c%e8%99%bd%e8%af%b4%e8%bf%99%e6%a0%b7%e7%9a%84%e6%96%87%e7%ab%a0%e5%b7%ae%e4%b8%8d%e5%a4%9a%e5%b7%b2%e7%bb%8f%e7%83%82%e5%a4%a7%e8%a1%97%e4%ba%86%ef%bc%8c%e8%bf%98%e6%98%af%e5%8f%af%e4%bb%a5%e7%9c%8b%e4%b8%80%e4%b8%8b%e7%9a%84%e3%80%82%0a1%e2%8e%88%e2%8e%88%202apt%20install%20-y%20bash-completion%203yum%20install%20-y%20bash-completion%204echo%20%26%2334%3bsource%20%26lt%3b%28kubectl%20completion%20bash%29%26%2334%3b%20%26gt%3b%26gt%3b%20~%2f.bashrc%205echo%20%26%2334%3bsource%20%26lt%3b%28kubeadm%20completion%20bash%29%26%2334%3b%20%26gt%3b%26gt%3b%20~%2f.bashrc%206source%20~%2f.bashrc%207modprobe%20ip_vs%20%26amp%3b%26amp%3b%20modprobe%20ip_vs_rr%20%26amp%3b%26amp%3b%20modprobe%20ip_vs_wrr%20%26amp%3b%26amp%3b%20modprobe%20ip_vs_sh%208rm%20-rf%20%2fvar%2flib%2fcni%2f%209rm%20-rf%20%2fvar%2flib%2fkubelet%2f%2a%2010rm%20-rf%20%2fetc%2fcni%2f%2011ip%20link%20del%20cni0%20%26amp%3b%26amp%3b%20ip%20link%20del%20flannel.1%20%26amp%3b%26amp%3b%20ip%20link%20del%20kube-ipvs0%2012net.ipv6.conf.all.disable_ipv6%20%3d%201%2013awk%20%26%2339%3b%242%20~%20path%20%7bprint%20%242%7d%26%2339%3b%20path%3d%2fvar%2flib%2fkubelet%20%2fproc%2fmounts%20%7c%20xargs%20-r%20umount%2014kubeadm%20init%20--kubernetes-version%201." aria-label="Tumblr">
      <i class="fab fa-tumblr " aria-hidden="true"></i>
    </a>
  </li>
  <li>
    <a class="icon" href="https://news.ycombinator.com/submitlink?u=https%3a%2f%2fexample.com%2fposts%2fcreate-cluster-use-kubeadm%2f&t=%e4%bd%bf%e7%94%a8kubeadm%e5%88%9d%e5%a7%8b%e5%8c%96%e9%9b%86%e7%be%a4" aria-label="Hacker News">
      <i class="fab fa-hacker-news " aria-hidden="true"></i>
    </a>
  </li>
</ul>

    </div>
    
    <div id="toc">
      <nav id="TableOfContents">
  <ul>
    <li><a href="#tldr">TL.DR</a></li>
    <li><a href="#一步一步装">一步一步装</a>
      <ul>
        <li><a href="#安装-docker">安装 Docker</a></li>
        <li><a href="#安装kubeadm">安装kubeadm</a></li>
        <li><a href="#准备工作">准备工作</a></li>
        <li><a href="#初始化静态pod">初始化静态pod</a></li>
        <li><a href="#生成的文件">生成的文件</a></li>
        <li><a href="#组件的启动参数">组件的启动参数</a>
          <ul>
            <li><a href="#manifestsetcdyaml">manifests/etcd.yaml</a></li>
            <li><a href="#manifestskube-apiserver">manifests/kube-apiserver</a></li>
            <li><a href="#kube-controller-manager">kube-controller-manager</a></li>
            <li><a href="#manifestskube-scheduler">manifests/kube-scheduler.</a></li>
            <li><a href="#查看状态">查看状态</a></li>
          </ul>
        </li>
      </ul>
    </li>
    <li><a href="#自定义配置">自定义配置</a></li>
    <li><a href="#master">Master</a></li>
    <li><a href="#node">node</a></li>
    <li><a href="#附录">附录</a></li>
    <li><a href="#ref">Ref</a></li>
  </ul>
</nav>
    </div>
    
  </span>
</div>


  <article class="post" itemscope itemtype="http://schema.org/BlogPosting">
    <header>
      <h1 class="posttitle" itemprop="name headline">
        使用kubeadm初始化集群
      </h1>
      <div class="meta">
        
        <div class="postdate">
          
          <time datetime="2019-05-17 22:31:20 &#43;0800 CST" itemprop="datePublished">2019-05-17</time>
          
        </div>
        
        
        <div class="article-read-time">
          <i class="far fa-clock"></i>
          
          17 minute read
        </div>
        
        
        
        <div class="article-tag">
            <i class="fas fa-tag"></i>
            
            
            <a class="tag-link" href="/tags/k8s" rel="tag">k8s</a>
            
        </div>
        
      </div>
    </header>

  
    
    <div class="content" itemprop="articleBody">
      <p>很久之前就写过这篇笔记，一直没发出来，虽说这样的文章差不多已经烂大街了，还是可以看一下的。</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash"><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 1</span>⎈⎈
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 2</span>apt install -y bash-completion
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 3</span>yum install -y bash-completion 
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 4</span><span style="color:#8be9fd;font-style:italic">echo</span> <span style="color:#f1fa8c">&#34;source &lt;(kubectl completion bash)&#34;</span> &gt;&gt; ~/.bashrc
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 5</span><span style="color:#8be9fd;font-style:italic">echo</span> <span style="color:#f1fa8c">&#34;source &lt;(kubeadm completion bash)&#34;</span> &gt;&gt; ~/.bashrc
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 6</span><span style="color:#8be9fd;font-style:italic">source</span> ~/.bashrc
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 7</span>modprobe ip_vs <span style="color:#ff79c6">&amp;&amp;</span> modprobe ip_vs_rr <span style="color:#ff79c6">&amp;&amp;</span> modprobe ip_vs_wrr <span style="color:#ff79c6">&amp;&amp;</span> modprobe ip_vs_sh
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 8</span>rm -rf /var/lib/cni/
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 9</span>rm -rf /var/lib/kubelet/*
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">10</span>rm -rf /etc/cni/
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">11</span>ip link del cni0 <span style="color:#ff79c6">&amp;&amp;</span> ip link del flannel.1 <span style="color:#ff79c6">&amp;&amp;</span> ip link del kube-ipvs0
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">12</span>net.ipv6.conf.all.disable_ipv6 <span style="color:#ff79c6">=</span> <span style="color:#bd93f9">1</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">13</span>awk <span style="color:#f1fa8c">&#39;$2 ~ path {print $2}&#39;</span> <span style="color:#8be9fd;font-style:italic">path</span><span style="color:#ff79c6">=</span>/var/lib/kubelet /proc/mounts | xargs -r umount
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">14</span>kubeadm init --kubernetes-version 1.11.1 --pod-network-cidr<span style="color:#ff79c6">=</span>10.244.0.0/16
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">15</span>kubectl apply -f https://raw.githubusercontent.com/coreos/flannel/v0.10.0/Documentation/kube-flannel.yml
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">16</span>kubectl taint nodes --all node-role.kubernetes.io/master-
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">17</span>kubectl run nginx --image<span style="color:#ff79c6">=</span>nginx:alpine --port<span style="color:#ff79c6">=</span><span style="color:#bd93f9">80</span> --replicas <span style="color:#bd93f9">1</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">18</span>kubectl expose deployment nginx --type<span style="color:#ff79c6">=</span>NodePort
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">19</span>kubectl run curl --image<span style="color:#ff79c6">=</span>vsxen/k8s --port<span style="color:#ff79c6">=</span><span style="color:#bd93f9">5201</span> -i --tty
</code></pre></div><h2 id="tldr">TL.DR</h2>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash"><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 1</span><span style="color:#ff79c6">#!/bin/bash
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 2</span><span style="color:#ff79c6"></span><span style="color:#8be9fd;font-style:italic">set</span> -x
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 3</span><span style="color:#8be9fd;font-style:italic">set</span> -e
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 4</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 5</span>curl -fsSL https://get.docker.com | bash -s docker --mirror Aliyun
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 6</span>cat &gt; /etc/docker/daemon.json <span style="color:#f1fa8c">&lt;&lt; EOF
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 7</span><span style="color:#f1fa8c">{
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 8</span><span style="color:#f1fa8c">  &#34;registry-mirrors&#34;: [&#34;https://docker.mirrors.ustc.edu.cn&#34;, &#34;https://2h3po24q.mirror.aliyuncs.com&#34;],
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 9</span><span style="color:#f1fa8c">  &#34;max-concurrent-downloads&#34;: 10
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">10</span><span style="color:#f1fa8c">  &#34;exec-opts&#34;: [&#34;native.cgroupdriver=systemd&#34;],
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">11</span><span style="color:#f1fa8c">    &#34;log-driver&#34;: &#34;json-file&#34;,
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">12</span><span style="color:#f1fa8c">    &#34;log-opts&#34;: {
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">13</span><span style="color:#f1fa8c">        &#34;max-size&#34;: &#34;100m&#34;,
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">14</span><span style="color:#f1fa8c">        &#34;max-file&#34;: &#34;10&#34;
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">15</span><span style="color:#f1fa8c">    }
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">16</span><span style="color:#f1fa8c">}
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">17</span><span style="color:#f1fa8c">EOF</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">18</span>systemctl restart docker 
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">19</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">20</span>cat <span style="color:#f1fa8c">&lt;&lt;EOF &gt;  /etc/sysctl.d/k8s.conf
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">21</span><span style="color:#f1fa8c">net.bridge.bridge-nf-call-ip6tables = 1
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">22</span><span style="color:#f1fa8c">net.bridge.bridge-nf-call-iptables = 1
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">23</span><span style="color:#f1fa8c">EOF</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">24</span>sysctl --system
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">25</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">26</span>cat <span style="color:#f1fa8c">&lt;&lt;EOF &gt; /etc/yum.repos.d/kubernetes.repo
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">27</span><span style="color:#f1fa8c">[kubernetes]
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">28</span><span style="color:#f1fa8c">name=Kubernetes
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">29</span><span style="color:#f1fa8c">baseurl=http://mirrors.aliyun.com/kubernetes/yum/repos/kubernetes-el7-x86_64
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">30</span><span style="color:#f1fa8c">enabled=1
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">31</span><span style="color:#f1fa8c">gpgcheck=0
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">32</span><span style="color:#f1fa8c">repo_gpgcheck=0
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">33</span><span style="color:#f1fa8c">gpgkey=http://mirrors.aliyun.com/kubernetes/yum/doc/yum-key.gpg
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">34</span><span style="color:#f1fa8c">        http://mirrors.aliyun.com/kubernetes/yum/doc/rpm-package-key.gpg
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">35</span><span style="color:#f1fa8c">EOF</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">36</span>yum install -y kubelet-1.11.1-0 kubeadm-1.11.1-0 kubectl-1.11.1-0 cri-tools-1.11.1-0
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">37</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">38</span>apt-get update <span style="color:#ff79c6">&amp;&amp;</span> apt-get install -y apt-transport-https
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">39</span>curl https://mirrors.aliyun.com/kubernetes/apt/doc/apt-key.gpg | apt-key add - 
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">40</span>cat <span style="color:#f1fa8c">&lt;&lt;EOF &gt;/etc/apt/sources.list.d/kubernetes.list
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">41</span><span style="color:#f1fa8c">deb https://mirrors.aliyun.com/kubernetes/apt/ kubernetes-xenial main
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">42</span><span style="color:#f1fa8c">EOF</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">43</span>apt-get update
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">44</span>apt install <span style="color:#8be9fd;font-style:italic">kubeadm</span><span style="color:#ff79c6">=</span>1.11.1-00 <span style="color:#8be9fd;font-style:italic">kubelet</span><span style="color:#ff79c6">=</span>1.11.1-00 kubernetes-cni<span style="color:#ff79c6">=</span>0.6.0-00 cri-tools<span style="color:#ff79c6">=</span>1.11.1-00
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">45</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">46</span><span style="color:#8be9fd;font-style:italic">KUBE_VERSION</span><span style="color:#ff79c6">=</span>v1.14.1
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">47</span><span style="color:#8be9fd;font-style:italic">KUBE_PAUSE_VERSION</span><span style="color:#ff79c6">=</span>3.1
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">48</span><span style="color:#8be9fd;font-style:italic">ETCD_VERSION</span><span style="color:#ff79c6">=</span>3.3.10
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">49</span><span style="color:#8be9fd;font-style:italic">DNS_VERSION</span><span style="color:#ff79c6">=</span>1.3.1
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">50</span><span style="color:#8be9fd;font-style:italic">GCR_URL</span><span style="color:#ff79c6">=</span>k8s.gcr.io
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">51</span><span style="color:#8be9fd;font-style:italic">HUB_URL</span><span style="color:#ff79c6">=</span>mirrorgooglecontainers
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">52</span><span style="color:#8be9fd;font-style:italic">images</span><span style="color:#ff79c6">=(</span>kube-proxy:<span style="color:#f1fa8c">${</span><span style="color:#8be9fd;font-style:italic">KUBE_VERSION</span><span style="color:#f1fa8c">}</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">53</span>kube-scheduler:<span style="color:#f1fa8c">${</span><span style="color:#8be9fd;font-style:italic">KUBE_VERSION</span><span style="color:#f1fa8c">}</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">54</span>kube-controller-manager:<span style="color:#f1fa8c">${</span><span style="color:#8be9fd;font-style:italic">KUBE_VERSION</span><span style="color:#f1fa8c">}</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">55</span>kube-apiserver:<span style="color:#f1fa8c">${</span><span style="color:#8be9fd;font-style:italic">KUBE_VERSION</span><span style="color:#f1fa8c">}</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">56</span>pause:<span style="color:#f1fa8c">${</span><span style="color:#8be9fd;font-style:italic">KUBE_PAUSE_VERSION</span><span style="color:#f1fa8c">}</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">57</span>etcd:<span style="color:#f1fa8c">${</span><span style="color:#8be9fd;font-style:italic">ETCD_VERSION</span><span style="color:#f1fa8c">}</span><span style="color:#ff79c6">)</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">58</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">59</span><span style="color:#ff79c6">for</span> imageName in <span style="color:#f1fa8c">${</span><span style="color:#8be9fd;font-style:italic">images</span>[@]<span style="color:#f1fa8c">}</span> ; <span style="color:#ff79c6">do</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">60</span>docker pull <span style="color:#8be9fd;font-style:italic">$HUB_URL</span>/<span style="color:#8be9fd;font-style:italic">$imageName</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">61</span>docker tag <span style="color:#8be9fd;font-style:italic">$HUB_URL</span>/<span style="color:#8be9fd;font-style:italic">$imageName</span> <span style="color:#8be9fd;font-style:italic">$GCR_URL</span>/<span style="color:#8be9fd;font-style:italic">$imageName</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">62</span>docker rmi <span style="color:#8be9fd;font-style:italic">$HUB_URL</span>/<span style="color:#8be9fd;font-style:italic">$imageName</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">63</span><span style="color:#ff79c6">done</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">64</span>docker pull coredns/coredns:<span style="color:#f1fa8c">${</span><span style="color:#8be9fd;font-style:italic">DNS_VERSION</span><span style="color:#f1fa8c">}</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">65</span>docker tag coredns/coredns:<span style="color:#f1fa8c">${</span><span style="color:#8be9fd;font-style:italic">DNS_VERSION</span><span style="color:#f1fa8c">}</span> <span style="color:#8be9fd;font-style:italic">$GCR_URL</span>/coredns:<span style="color:#f1fa8c">${</span><span style="color:#8be9fd;font-style:italic">DNS_VERSION</span><span style="color:#f1fa8c">}</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">66</span>docker rmi coredns/coredns:<span style="color:#f1fa8c">${</span><span style="color:#8be9fd;font-style:italic">DNS_VERSION</span><span style="color:#f1fa8c">}</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">67</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">68</span>docker pull jmgao1983/flannel:v0.10.0-amd64
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">69</span>docker tag jmgao1983/flannel:v0.10.0-amd64 quay.io/coreos/flannel:v0.10.0-amd64 
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">70</span>docker rmi jmgao1983/flannel:v0.10.0-amd64
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">71</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">72</span>systemctl <span style="color:#8be9fd;font-style:italic">enable</span> docker.service
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">73</span>kubeadm init --kubernetes-version 1.11.1 --pod-network-cidr<span style="color:#ff79c6">=</span>10.244.0.0/16 --apiserver-advertise-address
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">74</span>kubectl apply -f https://raw.githubusercontent.com/coreos/flannel/v0.10.0/Documentation/kube-flannel.yml
</code></pre></div><h2 id="一步一步装">一步一步装</h2>
<h3 id="安装-docker">安装 Docker</h3>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash"><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1</span>apt-get update
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">2</span>apt-get install -y apt-transport-https ca-certificates curl software-properties-common
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">3</span>curl -fsSL https://download.docker.com/linux/ubuntu/gpg | apt-key add -
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">4</span>add-apt-repository <span style="color:#f1fa8c">&#34;deb https://download.docker.com/linux/</span><span style="color:#ff79c6">$(</span>. /etc/os-release; <span style="color:#8be9fd;font-style:italic">echo</span> <span style="color:#f1fa8c">&#34;</span><span style="color:#8be9fd;font-style:italic">$ID</span><span style="color:#f1fa8c">&#34;</span><span style="color:#ff79c6">)</span><span style="color:#f1fa8c"> </span><span style="color:#ff79c6">$(</span>lsb_release -cs<span style="color:#ff79c6">)</span><span style="color:#f1fa8c"> stable&#34;</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">5</span>apt-get update <span style="color:#ff79c6">&amp;&amp;</span> apt-get install -y docker-ce<span style="color:#ff79c6">=</span><span style="color:#ff79c6">$(</span>apt-cache madison docker-ce | grep 17.03 | head -1 | awk <span style="color:#f1fa8c">&#39;{print $3}&#39;</span><span style="color:#ff79c6">)</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">6</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">7</span>yum install -y yum-utils device-mapper-persistent-data lvm2
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">8</span>yum-config-manager --add-repo http://mirrors.aliyun.com/docker-ce/linux/centos/docker-ce.repo
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">9</span>yum list docker-ce.x86_64  --showduplicates |sort -r
</code></pre></div><p>设置Docker代理</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash"><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 1</span><span style="color:#8be9fd;font-style:italic">SSIP</span><span style="color:#ff79c6">=</span>192.168.12.100
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 2</span>sudo mkdir -p /etc/systemd/system/docker.service.d
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 3</span>cat &gt; /etc/systemd/system/docker.service.d/http-proxy.conf <span style="color:#f1fa8c">&lt;&lt;EOF
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 4</span><span style="color:#f1fa8c">[Service]
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 5</span><span style="color:#f1fa8c">Environment=&#34;HTTP_PROXY=$SSIP:1080/&#34;
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 6</span><span style="color:#f1fa8c">EOF</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 7</span>cat &gt; /etc/docker/daemon.json <span style="color:#f1fa8c">&lt;&lt; EOF
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 8</span><span style="color:#f1fa8c">{
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 9</span><span style="color:#f1fa8c">  &#34;registry-mirrors&#34;: [&#34;https://docker.mirrors.ustc.edu.cn&#34;, &#34;https://2h3po24q.mirror.aliyuncs.com&#34;],
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">10</span><span style="color:#f1fa8c">  &#34;max-concurrent-downloads&#34;: 10
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">11</span><span style="color:#f1fa8c">}
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">12</span><span style="color:#f1fa8c">EOF</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">13</span>systemctl daemon-reload <span style="color:#ff79c6">&amp;&amp;</span> systemctl restart docker
</code></pre></div><h3 id="安装kubeadm">安装kubeadm</h3>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash"><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 1</span>apt-get update <span style="color:#ff79c6">&amp;&amp;</span> apt-get install -y apt-transport-https curl
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 2</span>curl -s https://packages.cloud.google.com/apt/doc/apt-key.gpg | apt-key add -
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 3</span><span style="color:#6272a4"># 使用代理</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 4</span>sudo vi /etc/apt/apt.conf.d/proxy.conf
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 5</span>Acquire::https::Proxy <span style="color:#f1fa8c">&#34;http://192.168.12.100:1080&#34;</span>;
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 6</span>Acquire::https::Proxy <span style="color:#f1fa8c">&#34;http://user:password@proxy.server:port/&#34;</span>;
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 7</span><span style="color:#8be9fd;font-style:italic">SSIP</span><span style="color:#ff79c6">=</span>192.168.12.102
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 8</span>curl --socks5 <span style="color:#8be9fd;font-style:italic">$SSIP</span>:1080 -s https://packages.cloud.google.com/apt/doc/apt-key.gpg | apt-key add -
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 9</span><span style="color:#8be9fd;font-style:italic">export</span> <span style="color:#8be9fd;font-style:italic">http_proxy</span><span style="color:#ff79c6">=</span>socks5://<span style="color:#8be9fd;font-style:italic">$SSIP</span>:1080 
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">10</span><span style="color:#6272a4">#后续apt会自动读取env，不需要设置代理</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">11</span>cat <span style="color:#f1fa8c">&lt;&lt;EOF &gt;/etc/apt/sources.list.d/kubernetes.list
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">12</span><span style="color:#f1fa8c">deb http://apt.kubernetes.io/ kubernetes-xenial main
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">13</span><span style="color:#f1fa8c">EOF</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">14</span>apt-get update
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">15</span>apt-get install -y kubelet kubeadm kubectl
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">16</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">17</span>yum list kubeadm --showduplicates
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">18</span>yum install -y kubelet-1.10.7-0 kubeadm-1.10.7-0 kubectl-1.10.7-0 cri-tools-1.10.7-0
</code></pre></div><p>kubeadm 为kubelet新增的启动参数</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash"><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 1</span>cat /etc/systemd/system/kubelet.service.d/10-kubeadm.conf
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 2</span><span style="color:#6272a4"># Note: This dropin only works with kubeadm and kubelet v1.11+</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 3</span><span style="color:#ff79c6">[</span>Service<span style="color:#ff79c6">]</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 4</span><span style="color:#8be9fd;font-style:italic">Environment</span><span style="color:#ff79c6">=</span><span style="color:#f1fa8c">&#34;KUBELET_KUBECONFIG_ARGS=--bootstrap-kubeconfig=/etc/kubernetes/bootstrap-kubelet.conf --kubeconfig=/etc/kubernetes/kubelet.conf&#34;</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 5</span><span style="color:#8be9fd;font-style:italic">Environment</span><span style="color:#ff79c6">=</span><span style="color:#f1fa8c">&#34;KUBELET_CONFIG_ARGS=--config=/var/lib/kubelet/config.yaml&#34;</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 6</span><span style="color:#6272a4"># This is a file that &#34;kubeadm init&#34; and &#34;kubeadm join&#34; generates at runtime, populating the KUBELET_KUBEADM_ARGS variable dynamically</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 7</span><span style="color:#8be9fd;font-style:italic">EnvironmentFile</span><span style="color:#ff79c6">=</span>-/var/lib/kubelet/kubeadm-flags.env
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 8</span><span style="color:#6272a4"># This is a file that the user can use for overrides of the kubelet args as a last resort. Preferably, the user should use</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 9</span><span style="color:#6272a4"># the .NodeRegistration.KubeletExtraArgs object in the configuration files instead. KUBELET_EXTRA_ARGS should be sourced from this file.</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">10</span><span style="color:#8be9fd;font-style:italic">EnvironmentFile</span><span style="color:#ff79c6">=</span>-/etc/default/kubelet
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">11</span><span style="color:#8be9fd;font-style:italic">ExecStart</span><span style="color:#ff79c6">=</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">12</span><span style="color:#8be9fd;font-style:italic">ExecStart</span><span style="color:#ff79c6">=</span>/usr/bin/kubelet <span style="color:#8be9fd;font-style:italic">$KUBELET_KUBECONFIG_ARGS</span> <span style="color:#8be9fd;font-style:italic">$KUBELET_CONFIG_ARGS</span> <span style="color:#8be9fd;font-style:italic">$KUBELET_KUBEADM_ARGS</span> <span style="color:#8be9fd;font-style:italic">$KUBELET_EXTRA_ARGS</span>
</code></pre></div><h3 id="准备工作">准备工作</h3>
<p>关闭swap和防火墙，不关闭会报错[ERROR Swap]: running with swap on is not supported. Please disable swap。
<code>swapoff -a</code>
如果之前设置了代理，现在要取消掉<code>unset http_proxy</code>，否则报错</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash"><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1</span>Jul <span style="color:#bd93f9">26</span> 09:52:34 ubuntu kubelet<span style="color:#ff79c6">[</span>3336<span style="color:#ff79c6">]</span>: E0726 09:52:34.391184    <span style="color:#bd93f9">3336</span> reflector.go:205<span style="color:#ff79c6">]</span> k8s.io/kubernetes/pkg/kubelet/kubelet.go:455: Failed to list *v1.Service: Get https://192.168.200.140:6443/api/v1/services?limit<span style="color:#ff79c6">=</span>500&amp;<span style="color:#8be9fd;font-style:italic">resourceVersion</span><span style="color:#ff79c6">=</span>0: net/http: TLS handshake timeout
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">2</span>Jul <span style="color:#bd93f9">26</span> 09:52:34 ubuntu kubelet<span style="color:#ff79c6">[</span>3336<span style="color:#ff79c6">]</span>: E0726 09:52:34.400787    <span style="color:#bd93f9">3336</span> reflector.go:205<span style="color:#ff79c6">]</span> k8s.io/kubernetes/pkg/kubelet/config/apiserver.go:47: Failed to list *v1.Pod: Get https://192.168.200.140:6443/api/v1/pods?fieldSelector<span style="color:#ff79c6">=</span>spec.nodeName%3Dubuntu&amp;<span style="color:#8be9fd;font-style:italic">limit</span><span style="color:#ff79c6">=</span>500&amp;<span style="color:#8be9fd;font-style:italic">resourceVersion</span><span style="color:#ff79c6">=</span>0: net/http: TLS handshake timeout
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">3</span>Jul <span style="color:#bd93f9">26</span> 09:52:34 ubuntu kubelet<span style="color:#ff79c6">[</span>3336<span style="color:#ff79c6">]</span>: E0726 09:52:34.403551    <span style="color:#bd93f9">3336</span> reflector.go:205<span style="color:#ff79c6">]</span> k8s.io/kubernetes/pkg/kubelet/kubelet.go:464: Failed to list *v1.Node: Get https://192.168.200.140:6443/api/v1/nodes?fieldSelector<span style="color:#ff79c6">=</span>metadata.name%3Dubuntu&amp;<span style="color:#8be9fd;font-style:italic">limit</span><span style="color:#ff79c6">=</span>500&amp;<span style="color:#8be9fd;font-style:italic">resourceVersion</span><span style="color:#ff79c6">=</span>0: net/http: TLS handshake timeout
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">4</span>Jul <span style="color:#bd93f9">26</span> 09:52:35 ubuntu kubelet<span style="color:#ff79c6">[</span>3336<span style="color:#ff79c6">]</span>: W0726 09:52:35.846994    <span style="color:#bd93f9">3336</span> cni.go:172<span style="color:#ff79c6">]</span> Unable to update cni config: No networks found in /etc/cni/net.d
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">5</span>Jul <span style="color:#bd93f9">26</span> 09:52:35 ubuntu kubelet<span style="color:#ff79c6">[</span>3336<span style="color:#ff79c6">]</span>: E0726 09:52:35.847929    <span style="color:#bd93f9">3336</span> kubelet.go:2110<span style="color:#ff79c6">]</span> Container runtime network not ready: <span style="color:#8be9fd;font-style:italic">NetworkReady</span><span style="color:#ff79c6">=</span><span style="color:#8be9fd;font-style:italic">false</span> reason:NetworkPluginNotReady message:docker: network plugin is not ready: cni config uninitialized
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">6</span>Jul <span style="color:#bd93f9">26</span> 09:52:37 ubuntu kubelet<span style="color:#ff79c6">[</span>3336<span style="color:#ff79c6">]</span>: E0726 09:52:37.408007    <span style="color:#bd93f9">3336</span> kubelet_node_status.go:103<span style="color:#ff79c6">]</span> Unable to register node <span style="color:#f1fa8c">&#34;ubuntu&#34;</span> with API server: Post https://192.168.200.140:6443/api/v1/nodes: net/http: TLS handshake timeout
</code></pre></div><h3 id="初始化静态pod">初始化静态pod</h3>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash"><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1</span><span style="color:#6272a4"># 这里使用flannel预先规定的CIDR</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">2</span>kubeadm init --kubernetes-version 1.11.0 --pod-network-cidr<span style="color:#ff79c6">=</span>10.244.0.0/16
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">3</span>You can now join any number of machines by running the following on each node
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">4</span>as root:
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">5</span>kubeadm join 192.168.200.140:6443 --token e12o5m.ablnnhbsojrl1g5t --discovery-token-ca-cert-hash sha256:ad11adbac1f2a9f963c4bb8c88dcf6dfa4c330ad79bef59cae7613388cfe6413
</code></pre></div><h3 id="生成的文件">生成的文件</h3>
<pre><code>├── admin.conf
├── controller-manager.conf
├── kubelet.conf
├── manifests
│   ├── etcd.yaml
│   ├── kube-apiserver.yaml
│   ├── kube-controller-manager.yaml
│   └── kube-scheduler.yaml
├── pki
│   ├── apiserver.crt
│   ├── apiserver-etcd-client.crt
│   ├── apiserver-etcd-client.key
│   ├── apiserver.key
│   ├── apiserver-kubelet-client.crt
│   ├── apiserver-kubelet-client.key
│   ├── ca.crt
│   ├── ca.key
│   ├── etcd
│   │   ├── ca.crt
│   │   ├── ca.key
│   │   ├── healthcheck-client.crt
│   │   ├── healthcheck-client.key
│   │   ├── peer.crt
│   │   ├── peer.key
│   │   ├── server.crt
│   │   └── server.key
│   ├── front-proxy-ca.crt
│   ├── front-proxy-ca.key
│   ├── front-proxy-client.crt
│   ├── front-proxy-client.key
│   ├── sa.key
│   └── sa.pub
└── scheduler.conf
</code></pre><h3 id="组件的启动参数">组件的启动参数</h3>
<h4 id="manifestsetcdyaml">manifests/etcd.yaml</h4>
<pre><code>    - etcd
    - --advertise-client-urls=https://127.0.0.1:2379
    - --cert-file=/etc/kubernetes/pki/etcd/server.crt
    - --client-cert-auth=true
    - --data-dir=/var/lib/etcd
    - --initial-advertise-peer-urls=https://127.0.0.1:2380
    - --initial-cluster=ubuntu=https://127.0.0.1:2380
    - --key-file=/etc/kubernetes/pki/etcd/server.key
    - --listen-client-urls=https://127.0.0.1:2379
    - --listen-peer-urls=https://127.0.0.1:2380
    - --name=ubuntu
    - --peer-cert-file=/etc/kubernetes/pki/etcd/peer.crt
    - --peer-client-cert-auth=true
    - --peer-key-file=/etc/kubernetes/pki/etcd/peer.key
    - --peer-trusted-ca-file=/etc/kubernetes/pki/etcd/ca.crt
    - --snapshot-count=10000
    - --trusted-ca-file=/etc/kubernetes/pki/etcd/ca.crt
    image: k8s.gcr.io/etcd-amd64:3.2.18
</code></pre><h4 id="manifestskube-apiserver">manifests/kube-apiserver</h4>
<pre><code>spec:
  containers:
  - command:
    - kube-apiserver
    - --authorization-mode=Node,RBAC
    - --advertise-address=192.168.200.140
    - --allow-privileged=true
    - --client-ca-file=/etc/kubernetes/pki/ca.crt
    - --disable-admission-plugins=PersistentVolumeLabel
    - --enable-admission-plugins=NodeRestriction
    - --enable-bootstrap-token-auth=true
    - --etcd-cafile=/etc/kubernetes/pki/etcd/ca.crt
    - --etcd-certfile=/etc/kubernetes/pki/apiserver-etcd-client.crt
    - --etcd-keyfile=/etc/kubernetes/pki/apiserver-etcd-client.key
    - --etcd-servers=https://127.0.0.1:2379
    - --insecure-port=0
    - --kubelet-client-certificate=/etc/kubernetes/pki/apiserver-kubelet-client.crt
    - --kubelet-client-key=/etc/kubernetes/pki/apiserver-kubelet-client.key
    - --kubelet-preferred-address-types=InternalIP,ExternalIP,Hostname
    - --proxy-client-cert-file=/etc/kubernetes/pki/front-proxy-client.crt
    - --proxy-client-key-file=/etc/kubernetes/pki/front-proxy-client.key
    - --requestheader-allowed-names=front-proxy-client
    - --requestheader-client-ca-file=/etc/kubernetes/pki/front-proxy-ca.crt
    - --requestheader-extra-headers-prefix=X-Remote-Extra-
    - --requestheader-group-headers=X-Remote-Group
    - --requestheader-username-headers=X-Remote-User
    - --secure-port=6443
    - --service-account-key-file=/etc/kubernetes/pki/sa.pub
    - --service-cluster-ip-range=10.96.0.0/12
    - --tls-cert-file=/etc/kubernetes/pki/apiserver.crt
    - --tls-private-key-file=/etc/kubernetes/pki/apiserver.key
    image: k8s.gcr.io/kube-apiserver-amd64:v1.11.0
</code></pre><h4 id="kube-controller-manager">kube-controller-manager</h4>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash"><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 1</span>spec:
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 2</span>  containers:
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 3</span>  - command:
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 4</span>    - kube-controller-manager
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 5</span>    - --address<span style="color:#ff79c6">=</span>127.0.0.1
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 6</span>    - --allocate-node-cidrs<span style="color:#ff79c6">=</span><span style="color:#8be9fd;font-style:italic">true</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 7</span>    - --cluster-cidr<span style="color:#ff79c6">=</span>10.244.0.0/16
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 8</span>    - --cluster-signing-cert-file<span style="color:#ff79c6">=</span>/etc/kubernetes/pki/ca.crt
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 9</span>    - --cluster-signing-key-file<span style="color:#ff79c6">=</span>/etc/kubernetes/pki/ca.key
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">10</span>    - --controllers<span style="color:#ff79c6">=</span>*,bootstrapsigner,tokencleaner
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">11</span>    - --kubeconfig<span style="color:#ff79c6">=</span>/etc/kubernetes/controller-manager.conf
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">12</span>    - --leader-elect<span style="color:#ff79c6">=</span><span style="color:#8be9fd;font-style:italic">true</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">13</span>    - --node-cidr-mask-size<span style="color:#ff79c6">=</span><span style="color:#bd93f9">24</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">14</span>    - --root-ca-file<span style="color:#ff79c6">=</span>/etc/kubernetes/pki/ca.crt
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">15</span>    - --service-account-private-key-file<span style="color:#ff79c6">=</span>/etc/kubernetes/pki/sa.key
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">16</span>    - --use-service-account-credentials<span style="color:#ff79c6">=</span><span style="color:#8be9fd;font-style:italic">true</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">17</span>    image: k8s.gcr.io/kube-controller-manager-amd64:v1.11.0
</code></pre></div><h4 id="manifestskube-scheduler">manifests/kube-scheduler.</h4>
<pre><code>spec:
  containers:
  - command:
    - kube-scheduler
    - --address=127.0.0.1
    - --kubeconfig=/etc/kubernetes/scheduler.conf
    - --leader-elect=true
    image: k8s.gcr.io/kube-scheduler-amd64:v1.11.0
</code></pre><h4 id="查看状态">查看状态</h4>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash"><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1</span>kubectl -n kube-system get po -o wide
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">2</span>NAME                             READY     STATUS    RESTARTS   AGE       IP                NODE
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">3</span>coredns-78fcdf6894-495rm         0/1       Pending   <span style="color:#bd93f9">0</span>          15m       &lt;none&gt;            &lt;none&gt;
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">4</span>coredns-78fcdf6894-qvfvf         0/1       Pending   <span style="color:#bd93f9">0</span>          15m       &lt;none&gt;            &lt;none&gt;
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">5</span>etcd-ubuntu                      1/1       Running   <span style="color:#bd93f9">0</span>          15m       192.168.200.140   ubuntu
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">6</span>kube-apiserver-ubuntu            1/1       Running   <span style="color:#bd93f9">0</span>          14m       192.168.200.140   ubuntu
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">7</span>kube-controller-manager-ubuntu   1/1       Running   <span style="color:#bd93f9">0</span>          14m       192.168.200.140   ubuntu
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">8</span>kube-proxy-csr55                 1/1       Running   <span style="color:#bd93f9">0</span>          15m       192.168.200.140   ubuntu
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">9</span>kube-scheduler-ubuntu            1/1       Running   <span style="color:#bd93f9">0</span>          14m       192.168.200.140   ubuntu
</code></pre></div><h2 id="自定义配置">自定义配置</h2>
<p>应该仅适用于1.14版本</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-yaml" data-lang="yaml"><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 1</span><span style="color:#ff79c6">apiVersion</span>: kubeadm.k8s.io/v1beta1
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 2</span><span style="color:#ff79c6">kind</span>: InitConfiguration
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 3</span><span style="color:#ff79c6">bootstrapTokens</span>:
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 4</span>- <span style="color:#ff79c6">groups</span>:
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 5</span>  - system:bootstrappers:kubeadm:default-node-token
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 6</span>  <span style="color:#6272a4">#token: abcdef.0123456789abcdef</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 7</span>  <span style="color:#ff79c6">ttl</span>: 24h0m0s
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 8</span>  <span style="color:#ff79c6">usages</span>:
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 9</span>  - signing
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">10</span>  - authentication
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">11</span><span style="color:#ff79c6">nodeRegistration</span>:
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">12</span>  <span style="color:#ff79c6">criSocket</span>: /var/run/dockershim.sock
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">13</span>  <span style="color:#ff79c6">name</span>: east1-monitor1
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">14</span>  <span style="color:#ff79c6">taints</span>:
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">15</span>  - <span style="color:#ff79c6">effect</span>: NoSchedule
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">16</span>    <span style="color:#ff79c6">key</span>: node-role.kubernetes.io/master
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">17</span>---
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">18</span><span style="color:#ff79c6">apiVersion</span>: kubeadm.k8s.io/v1beta1
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">19</span><span style="color:#ff79c6">kind</span>: ClusterConfiguration
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">20</span><span style="color:#ff79c6">apiServer</span>:
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">21</span>  <span style="color:#ff79c6">timeoutForControlPlane</span>: 4m0s
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">22</span>  <span style="color:#ff79c6">extraArgs</span>:
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">23</span>    <span style="color:#ff79c6">audit-log-maxbackup</span>: <span style="color:#f1fa8c">&#34;10&#34;</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">24</span>    <span style="color:#ff79c6">audit-log-maxsize</span>: <span style="color:#f1fa8c">&#34;100&#34;</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">25</span>    <span style="color:#ff79c6">audit-log-path</span>: <span style="color:#f1fa8c">&#34;/var/log/kubernetes/kubernetes.audit&#34;</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">26</span>    <span style="color:#ff79c6">audit-log-maxage</span>: <span style="color:#f1fa8c">&#34;7&#34;</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">27</span>    <span style="color:#ff79c6">audit-policy-file</span>: <span style="color:#f1fa8c">&#34;/etc/kubernetes/audit.yml&#34;</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">28</span>  <span style="color:#ff79c6">extraVolumes</span>:
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">29</span>  - <span style="color:#ff79c6">name</span>: <span style="color:#f1fa8c">&#34;audit&#34;</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">30</span>    <span style="color:#ff79c6">hostPath</span>: <span style="color:#f1fa8c">&#34;/etc/kubernetes/audit.yml&#34;</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">31</span>    <span style="color:#ff79c6">mountPath</span>: <span style="color:#f1fa8c">&#34;/etc/kubernetes/audit.yml&#34;</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">32</span>    <span style="color:#ff79c6">writable</span>: <span style="color:#ff79c6">true</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">33</span>    <span style="color:#ff79c6">pathType</span>: File
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">34</span>  - <span style="color:#ff79c6">name</span>: <span style="color:#f1fa8c">&#34;log&#34;</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">35</span>    <span style="color:#ff79c6">hostPath</span>: <span style="color:#f1fa8c">&#34;/var/log/kubernetes&#34;</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">36</span>    <span style="color:#ff79c6">mountPath</span>: <span style="color:#f1fa8c">&#34;/var/log/kubernetes&#34;</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">37</span>    <span style="color:#ff79c6">writable</span>: <span style="color:#ff79c6">true</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">38</span>    <span style="color:#ff79c6">pathType</span>: Directory
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">39</span><span style="color:#ff79c6">certificatesDir</span>: /etc/kubernetes/pki
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">40</span><span style="color:#ff79c6">clusterName</span>: kubernetes
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">41</span><span style="color:#ff79c6">controlPlaneEndpoint</span>: <span style="color:#f1fa8c">&#34;&#34;</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">42</span><span style="color:#ff79c6">imageRepository</span>: k8s.gcr.io
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">43</span><span style="color:#ff79c6">kubernetesVersion</span>: v1.14.0
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">44</span><span style="color:#ff79c6">controllerManager</span>: {}
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">45</span><span style="color:#ff79c6">scheduler</span>: {}
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">46</span><span style="color:#ff79c6">dns</span>:
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">47</span>  <span style="color:#ff79c6">type</span>: CoreDNS
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">48</span><span style="color:#ff79c6">etcd</span>:
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">49</span>  <span style="color:#ff79c6">local</span>:
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">50</span>    <span style="color:#ff79c6">dataDir</span>: /var/lib/etcd
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">51</span><span style="color:#ff79c6">networking</span>:
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">52</span>  <span style="color:#ff79c6">dnsDomain</span>: cluster.local
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">53</span>  <span style="color:#ff79c6">podSubnet</span>: <span style="color:#f1fa8c">&#34;10.244.0.0/16&#34;</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">54</span>  <span style="color:#ff79c6">serviceSubnet</span>: <span style="color:#bd93f9">10.96.0.0</span>/12
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">55</span>---
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">56</span><span style="color:#ff79c6">apiVersion</span>: kubeproxy.config.k8s.io/v1alpha1
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">57</span><span style="color:#ff79c6">kind</span>: KubeProxyConfiguration
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">58</span><span style="color:#ff79c6">ipvs</span>:
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">59</span> <span style="color:#ff79c6">excludeCIDRs</span>: <span style="color:#ff79c6">null</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">60</span> <span style="color:#ff79c6">minSyncPeriod</span>: 1s
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">61</span> <span style="color:#ff79c6">scheduler</span>: <span style="color:#f1fa8c">&#34;rr&#34;</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">62</span> <span style="color:#ff79c6">syncPeriod</span>: 30s
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">63</span><span style="color:#ff79c6">mode</span>: ipvs
</code></pre></div><p>不得不说，kubeadm大大的降低了初始化k8s集群的难度，接下来我尝试从初始化输出的日志中探究kubeadn到底替我们做了哪些事情。</p>
<h2 id="master">Master</h2>
<p>安装前检查，检查包括IP，路由，端口，命令，镜像，然后生成证书和对应的static pod，等待pod启动并初始化，这一步信息比较多就不放了。然后把kubeadm的应答config放到了k8s的configmap之中，上传kubelet的配置，方便节点在加入的时候配置信息。</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash"><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1</span>I0403 11:30:25.053837   <span style="color:#bd93f9">25657</span> uploadconfig.go:109<span style="color:#ff79c6">][</span>upload-config<span style="color:#ff79c6">]</span> Uploading the kubeadm ClusterConfiguration to a ConfigMap
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">2</span><span style="color:#ff79c6">[</span>upload-config<span style="color:#ff79c6">]</span> storing the configuration used in ConfigMap <span style="color:#f1fa8c">&#34;kubeadm-config&#34;</span> in the <span style="color:#f1fa8c">&#34;kube-system&#34;</span> Namespace
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">3</span>I0403 11:30:25.056662   <span style="color:#bd93f9">25657</span> round_trippers.go:438<span style="color:#ff79c6">]</span> GET https://192.168.1.11:6443/api/v1/namespaces/kube-system/configmaps/kubeadm-config <span style="color:#bd93f9">404</span> Not Found in <span style="color:#bd93f9">1</span> milliseconds
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">4</span>I0403 11:30:25.061844   <span style="color:#bd93f9">25657</span> round_trippers.go:438<span style="color:#ff79c6">]</span> POST https://192.168.1.11:6443/api/v1/namespaces/kube-system/configmaps <span style="color:#bd93f9">201</span> Created in <span style="color:#bd93f9">4</span> milliseconds
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">5</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">6</span>I0403 11:30:25.070763   <span style="color:#bd93f9">25657</span> uploadconfig.go:123<span style="color:#ff79c6">]</span> <span style="color:#ff79c6">[</span>upload-config<span style="color:#ff79c6">]</span> Uploading the kubelet component config to a ConfigMap
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">7</span><span style="color:#ff79c6">[</span>kubelet<span style="color:#ff79c6">]</span> Creating a ConfigMap <span style="color:#f1fa8c">&#34;kubelet-config-1.13&#34;</span> in namespace kube-system with the configuration <span style="color:#ff79c6">for</span> the kubelets in the cluster
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">8</span>I0403 11:30:25.074150   <span style="color:#bd93f9">25657</span> round_trippers.go:438<span style="color:#ff79c6">]</span> POST https://192.168.1.11:6443/api/v1/namespaces/kube-system/configmaps <span style="color:#bd93f9">201</span> Created in <span style="color:#bd93f9">2</span> milliseconds
</code></pre></div><p>创建 kubeadm:nodes-kubeadm-config Role，赋予了system:nodes system:bootstrappers:kubeadm:default-node-token 读取kubeadmconfig的权限，对于前者，在加入的时候第一步就是读取kubeadm的配置。</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-yaml" data-lang="yaml"><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 1</span><span style="color:#6272a4"># I0403 11:30:25.065774   25657 round_trippers.go:438] POST https://192.168.1.11:6443/apis/rbac.authorization.k8s.io/v1/namespaces/kube-system/roles 201 Created in 3 milliseconds</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 2</span><span style="color:#ff79c6">kind</span>: Role
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 3</span><span style="color:#ff79c6">apiVersion</span>: rbac.authorization.k8s.io/v1
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 4</span><span style="color:#ff79c6">metadata</span>:
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 5</span>  <span style="color:#ff79c6">name</span>: kubeadm:nodes-kubeadm-config
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 6</span>  <span style="color:#ff79c6">namespace</span>: kube-system
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 7</span><span style="color:#ff79c6">rules</span>:
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 8</span>- <span style="color:#ff79c6">verbs</span>:
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 9</span>  - get
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">10</span>  <span style="color:#ff79c6">apiGroups</span>:
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">11</span>  - <span style="color:#f1fa8c">&#39;&#39;</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">12</span>  <span style="color:#ff79c6">resources</span>:
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">13</span>  - configmaps
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">14</span>  <span style="color:#ff79c6">resourceNames</span>:
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">15</span>  - kubeadm-config
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">16</span><span style="color:#6272a4"># I0403 11:30:25.069802   25657 round_trippers.go:438] POST https://192.168.1.11:6443/apis/rbac.authorization.k8s.io/v1/namespaces/kube-system/rolebindings 201 Created in 3 milliseconds  </span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">17</span><span style="color:#ff79c6">kind</span>: RoleBinding
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">18</span><span style="color:#ff79c6">apiVersion</span>: rbac.authorization.k8s.io/v1
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">19</span><span style="color:#ff79c6">metadata</span>:
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">20</span>  <span style="color:#ff79c6">name</span>: kubeadm:nodes-kubeadm-config
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">21</span>  <span style="color:#ff79c6">namespace</span>: kube-system
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">22</span><span style="color:#ff79c6">subjects</span>:
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">23</span>- <span style="color:#ff79c6">kind</span>: Group
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">24</span>  <span style="color:#ff79c6">apiGroup</span>: rbac.authorization.k8s.io
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">25</span>  <span style="color:#ff79c6">name</span>: system:bootstrappers:kubeadm:default-node-token
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">26</span>- <span style="color:#ff79c6">kind</span>: Group
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">27</span>  <span style="color:#ff79c6">apiGroup</span>: rbac.authorization.k8s.io
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">28</span>  <span style="color:#ff79c6">name</span>: system:nodes
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">29</span><span style="color:#ff79c6">roleRef</span>:
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">30</span>  <span style="color:#ff79c6">apiGroup</span>: rbac.authorization.k8s.io
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">31</span>  <span style="color:#ff79c6">kind</span>: Role
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">32</span>  <span style="color:#ff79c6">name</span>: kubeadm:nodes-kubeadm-config
</code></pre></div><p>添加 kubeadm:kubelet-config-1.14 role，赋予了system:nodes 和 system:bootstrappers:kubeadm:default-node-token 读取kubeadmconfig的权限，允许其读取kubelet 的配置。</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-yaml" data-lang="yaml"><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 1</span><span style="color:#6272a4"># I0403 11:30:25.077100   25657 round_trippers.go:438] POST https://192.168.1.11:6443/apis/rbac.authorization.k8s.io/v1/namespaces/kube-system/roles 201 Created in 2 milliseconds</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 2</span><span style="color:#ff79c6">kind</span>: Role
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 3</span><span style="color:#ff79c6">apiVersion</span>: rbac.authorization.k8s.io/v1
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 4</span><span style="color:#ff79c6">metadata</span>:
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 5</span>  <span style="color:#ff79c6">name</span>: kubeadm:kubelet-config-1.14
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 6</span>  <span style="color:#ff79c6">namespace</span>: kube-system
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 7</span><span style="color:#ff79c6">rules</span>:
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 8</span>- <span style="color:#ff79c6">verbs</span>:
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 9</span>  - get
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">10</span>  <span style="color:#ff79c6">apiGroups</span>:
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">11</span>  - <span style="color:#f1fa8c">&#39;&#39;</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">12</span>  <span style="color:#ff79c6">resources</span>:
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">13</span>  - configmaps
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">14</span>  <span style="color:#ff79c6">resourceNames</span>:
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">15</span>  - kubelet-config-1.14
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">16</span>---
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">17</span><span style="color:#6272a4"># I0403 11:30:25.079638   25657 round_trippers.go:438] POST https://192.168.1.11:6443/apis/rbac.authorization.k8s.io/v1/namespaces/kube-system/rolebindings 201 Created in 2 milliseconds</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">18</span>---
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">19</span><span style="color:#ff79c6">kind</span>: RoleBinding
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">20</span><span style="color:#ff79c6">apiVersion</span>: rbac.authorization.k8s.io/v1
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">21</span><span style="color:#ff79c6">metadata</span>:
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">22</span>  <span style="color:#ff79c6">name</span>: kubeadm:kubelet-config-1.14
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">23</span>  <span style="color:#ff79c6">namespace</span>: kube-system
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">24</span><span style="color:#ff79c6">subjects</span>:
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">25</span>- <span style="color:#ff79c6">kind</span>: Group
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">26</span>  <span style="color:#ff79c6">apiGroup</span>: rbac.authorization.k8s.io
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">27</span>  <span style="color:#ff79c6">name</span>: system:nodes
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">28</span>- <span style="color:#ff79c6">kind</span>: Group
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">29</span>  <span style="color:#ff79c6">apiGroup</span>: rbac.authorization.k8s.io
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">30</span>  <span style="color:#ff79c6">name</span>: system:bootstrappers:kubeadm:default-node-token
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">31</span><span style="color:#ff79c6">roleRef</span>:
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">32</span>  <span style="color:#ff79c6">apiGroup</span>: rbac.authorization.k8s.io
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">33</span>  <span style="color:#ff79c6">kind</span>: Role
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">34</span>  <span style="color:#ff79c6">name</span>: kubeadm:kubelet-config-1.14
</code></pre></div><p>注册节点，并禁止调度到此节点。</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash"><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1</span>I0403 11:30:25.079743   <span style="color:#bd93f9">25657</span> uploadconfig.go:128<span style="color:#ff79c6">][</span>upload-config<span style="color:#ff79c6">]</span> Preserving the CRISocket information <span style="color:#ff79c6">for</span> the control-plane node
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">2</span>I0403 11:30:25.079755   <span style="color:#bd93f9">25657</span> patchnode.go:30<span style="color:#ff79c6">]</span> <span style="color:#ff79c6">[</span>patchnode<span style="color:#ff79c6">]</span> Uploading the CRI Socket information <span style="color:#f1fa8c">&#34;/var/run/dockershim.sock&#34;</span> to the Node API object <span style="color:#f1fa8c">&#34;east1-monitor1&#34;</span> as an annotation
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">3</span>I0403 11:30:25.582567   <span style="color:#bd93f9">25657</span> round_trippers.go:438<span style="color:#ff79c6">]</span> GET https://192.168.1.11:6443/api/v1/nodes/east1-monitor1 <span style="color:#bd93f9">200</span> OK in <span style="color:#bd93f9">2</span> milliseconds
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">4</span>I0403 11:30:25.590791   <span style="color:#bd93f9">25657</span> round_trippers.go:438<span style="color:#ff79c6">]</span> PATCH https://192.168.1.11:6443/api/v1/nodes/east1-monitor1 <span style="color:#bd93f9">200</span> OK in <span style="color:#bd93f9">4</span> milliseconds
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">5</span><span style="color:#ff79c6">[</span>upload-certs<span style="color:#ff79c6">]</span> Skipping phase. Please see --experimental-upload-certs
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">6</span><span style="color:#ff79c6">[</span>mark-control-plane<span style="color:#ff79c6">]</span> Marking the node east1-monitor1 as control-plane by adding the label <span style="color:#f1fa8c">&#34;node-role.kubernetes.io/master=&#39;&#39;&#34;</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">7</span><span style="color:#ff79c6">[</span>mark-control-plane<span style="color:#ff79c6">]</span> Marking the node east1-monitor1 as control-plane by adding the taints <span style="color:#ff79c6">[</span>node-role.kubernetes.io/master:NoSchedule<span style="color:#ff79c6">]</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">8</span>I0403 11:30:26.093669   <span style="color:#bd93f9">25657</span> round_trippers.go:438<span style="color:#ff79c6">]</span> GET https://192.168.1.11:6443/api/v1/nodes/east1-monitor1 <span style="color:#bd93f9">200</span> OK in <span style="color:#bd93f9">2</span> milliseconds
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">9</span>I0403 11:30:26.100968   <span style="color:#bd93f9">25657</span> round_trippers.go:438<span style="color:#ff79c6">]</span> PATCH https://192.168.1.11:6443/api/v1/nodes/east1-monitor1 <span style="color:#bd93f9">200</span> OK in <span style="color:#bd93f9">4</span> milliseconds
</code></pre></div><p>创建bootstrap token，存到k8s中，允许system:bootstrappers:kubeadm:default-node-token</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-yaml" data-lang="yaml"><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 1</span><span style="color:#6272a4">#[bootstrap-token] Using token: cr3n6a.5ndgdhxeyinfq7i0</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 2</span><span style="color:#6272a4">#[bootstrap-token] Configuring bootstrap tokens, cluster-info ConfigMap, RBAC Roles</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 3</span><span style="color:#6272a4">#I0403 11:30:26.103085   25657 round_trippers.go:438] GET https://192.168.1.11:6443/api/v1/namespaces/kube-system/secrets/bootstrap-token-cr3n6a 404 Not Found in 1 milliseconds</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 4</span><span style="color:#6272a4">#I0403 11:30:26.106375   25657 round_trippers.go:438] POST https://192.168.1.11:6443/api/v1/namespaces/kube-system/secrets 201 Created in 2 milliseconds</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 5</span>---
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 6</span><span style="color:#ff79c6">kind</span>: Secret
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 7</span><span style="color:#ff79c6">apiVersion</span>: v1
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 8</span><span style="color:#ff79c6">metadata</span>:
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 9</span>  <span style="color:#ff79c6">name</span>: bootstrap-token-o6k5na
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">10</span>  <span style="color:#ff79c6">namespace</span>: kube-system
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">11</span>  <span style="color:#ff79c6">creationTimestamp</span>: 
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">12</span><span style="color:#ff79c6">data</span>:
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">13</span>  <span style="color:#ff79c6">auth-extra-groups</span>: c3lzdGVtOmJvb3RzdHJhcHBlcnM6a3ViZWFkbTpkZWZhdWx0LW5vZGUtdG9rZW4=
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">14</span>  <span style="color:#ff79c6">description</span>: VGhlIGRlZmF1bHQgYm9vdHN0cmFwIHRva2VuIGdlbmVyYXRlZCBieSAna3ViZWFkbSBpbml0Jy4=
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">15</span>  <span style="color:#ff79c6">expiration</span>: MjAxOS0wNC0wOVQxOTozNjoyMCswODowMA==
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">16</span>  <span style="color:#ff79c6">token-id</span>: bzZrNW5h
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">17</span>  <span style="color:#ff79c6">token-secret</span>: ZzQzd3A1dHkzajJ5ZWxmMA==
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">18</span>  <span style="color:#ff79c6">usage-bootstrap-authentication</span>: dHJ1ZQ==
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">19</span>  <span style="color:#ff79c6">usage-bootstrap-signing</span>: dHJ1ZQ==
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">20</span><span style="color:#ff79c6">type</span>: bootstrap.kubernetes.io/token
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">21</span><span style="color:#6272a4"># [bootstrap-token] configured RBAC rules to allow Node Bootstrap tokens to post CSRs in order for nodes to get long term certificate credentials</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">22</span><span style="color:#6272a4">#I0403 11:30:26.110092   25657 round_trippers.go:438] POST https://192.168.1.11:6443/apis/rbac.authorization.k8s.io/v1/clusterrolebindings 201 Created in 2 milliseconds</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">23</span>---
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">24</span><span style="color:#ff79c6">kind</span>: ClusterRoleBinding
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">25</span><span style="color:#ff79c6">apiVersion</span>: rbac.authorization.k8s.io/v1
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">26</span><span style="color:#ff79c6">metadata</span>:
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">27</span>  <span style="color:#ff79c6">name</span>: kubeadm:kubelet-bootstrap
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">28</span><span style="color:#ff79c6">subjects</span>:
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">29</span>- <span style="color:#ff79c6">kind</span>: Group
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">30</span>  <span style="color:#ff79c6">apiGroup</span>: rbac.authorization.k8s.io
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">31</span>  <span style="color:#ff79c6">name</span>: system:bootstrappers:kubeadm:default-node-token
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">32</span><span style="color:#ff79c6">roleRef</span>:
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">33</span>  <span style="color:#ff79c6">apiGroup</span>: rbac.authorization.k8s.io
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">34</span>  <span style="color:#ff79c6">kind</span>: ClusterRole
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">35</span>  <span style="color:#ff79c6">name</span>: system:node-bootstrapper
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">36</span><span style="color:#6272a4">#  有对 certificatesigningrequests.certificates.k8s.io[create get list watch] 的权限 </span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">37</span><span style="color:#6272a4">#[bootstrap-token] configured RBAC rules to allow certificate rotation for all node client certificates in the cluster</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">38</span><span style="color:#6272a4">#I0403 11:30:26.115312   25657 round_trippers.go:438] POST https://192.168.1.11:6443/apis/rbac.authorization.k8s.io/v1/clusterrolebindings 201 Created in 2 milliseconds</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">39</span>---
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">40</span><span style="color:#ff79c6">kind</span>: ClusterRoleBinding
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">41</span><span style="color:#ff79c6">apiVersion</span>: rbac.authorization.k8s.io/v1
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">42</span><span style="color:#ff79c6">metadata</span>:
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">43</span>  <span style="color:#ff79c6">name</span>: kubeadm:node-autoapprove-certificate-rotation
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">44</span>  <span style="color:#ff79c6">creationTimestamp</span>: 
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">45</span><span style="color:#ff79c6">subjects</span>:
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">46</span>- <span style="color:#ff79c6">kind</span>: Group
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">47</span>  <span style="color:#ff79c6">name</span>: system:nodes
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">48</span><span style="color:#ff79c6">roleRef</span>:
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">49</span>  <span style="color:#ff79c6">apiGroup</span>: rbac.authorization.k8s.io
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">50</span>  <span style="color:#ff79c6">kind</span>: ClusterRole
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">51</span>  <span style="color:#ff79c6">name</span>: system:certificates.k8s.io:certificatesigningrequests:selfnodeclient
</code></pre></div><p>生成kubectl cluster-info 所需要的信息，并存储到configmap之中，同时在node加入的时候需要读取这里的CA信息。</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-yaml" data-lang="yaml"><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 1</span><span style="color:#6272a4"># [bootstrap-token] creating the &#34;cluster-info&#34; ConfigMap in the &#34;kube-public&#34; namespace</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 2</span><span style="color:#6272a4">#I0403 11:30:26.115417   25657 clusterinfo.go:46][bootstrap-token] loading admin kubeconfig</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 3</span>---
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 4</span><span style="color:#ff79c6">kind</span>: ConfigMap
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 5</span><span style="color:#ff79c6">apiVersion</span>: v1
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 6</span><span style="color:#ff79c6">metadata</span>:
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 7</span>  <span style="color:#ff79c6">name</span>: cluster-info
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 8</span>  <span style="color:#ff79c6">namespace</span>: kube-public
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 9</span>  <span style="color:#ff79c6">creationTimestamp</span>: 
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">10</span><span style="color:#ff79c6">data</span>:
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">11</span>  <span style="color:#ff79c6">kubeconfig</span>: |<span style="color:#f1fa8c">
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">12</span><span style="color:#f1fa8c">    apiVersion: v1
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">13</span><span style="color:#f1fa8c">    clusters:
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">14</span><span style="color:#f1fa8c">    - cluster:
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">15</span><span style="color:#f1fa8c">        certificate-authority-data: LS0tLS1CRUdJTiBDRVJUSUZJQ0FURS0tLS0tCk1JSUN5RENDQWJDZ0F3SUJBZ0lCQURBTkJna3Foa2lHOXcwQkFRc0ZBREFWTVJNd0VRWURWUVFERXdwcmRXSmwKY201bGRHVnpNQjRYRFRFNU1EUXdPREV4TXpVMU5Gb1hEVEk1TURRd05URXhNelUxTkZvd0ZURVRNQkVHQTFVRQpBeE1LYTNWaVpYSnVaWFJsY3pDQ0FTSXdEUVlKS29aSWh2Y05BUUVCQlFBRGdnRVBBRENDQVFvQ2dnRUJBTm1XClJhWWN1Z0F1VzlKV2NHVGpkOW12RkZnU1NWOGo3N2NoSzY0eEIyWEN0MzVwMkpSOEUzWkVBekdvZjNaUDRmcFYKVUVadWRCU3p6c25ZMGdUQ1QwL2F6SzI1ME1nLzZ4TmFmYXdJbytXSUNDS2NYYkRlbGRxS3FQbEorenNCekd4eQpnd2kwOTlzQXhPK0dzOVVTQndHNm1hcThZMjVvNlE5SER3RjlTdTRSdDlDaHpMNWRSL0ZHNXduY1VNWGxUK2kzCnVsbldOVWVxV3VGKzh4WGJsQ291b2NtUFZnc292cnZka1prVE5GbVFoVjhnYW9TR3I1eVNLNEpVelVFMXNrck8KbTBLbXIxZTQvQ05obEI2dmZjNEJ0S2JscFp6UzEzU1FBMktwK2I2ek9zVEhkc0ZWS1hQMlI4eFpXTHh1Q2ZMRApEQXorRmhpa0VqMWJsNU1YYmUwQ0F3RUFBYU1qTUNFd0RnWURWUjBQQVFIL0JBUURBZ0trTUE4R0ExVWRFd0VCCi93UUZNQU1CQWY4d0RRWUpLb1pJaHZjTkFRRUxCUUFEZ2dFQkFBTjF5cGJIYmRjVjZQWjBjL3ViOUg1a0JxK3AKSkJ6Wk40R2lmMHV5U2daM3RXUENiMVlqSjA5K3B1LzQ4ZE1zWHppdnFkNTVqaHFyM04yZ0RvOWE4Z2N2WXowMwp0RG1oR1kzTXgvbHBMcGhjMUZqMmdyanQ3WldHNzYzd2hsNkhkcFRuRVh1enhRT20ya1c3K210ZEFsRUZxaUtpCnRzdll4cDlmTHRyUkhwRGhZT1g4NUFzbFA4VGMvNXY4c0RFd2UzbGNBbndmQXBScGZCdWJ2cjVYN0tWTk9ZMnAKOGFnMTErL0hrUHIvSHJKTWlhcmVYeUdhL2Jac1lMTW8zUGdsZnJJOG1rNE5pZkc3bm9UbzN5b1k5RTBHWWI5UQpwTTl2bU8zbHkwMkxBV1pBSkJGMXVwVVJrWnhZZ3VEc1MwNms4c0tGRWptSWZXZjVxRnU4ZzRLS084Yz0KLS0tLS1FTkQgQ0VSVElGSUNBVEUtLS0tLQo=
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">16</span><span style="color:#f1fa8c">        server: https://192.168.0.1:6443
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">17</span><span style="color:#f1fa8c">      name: &#34;&#34;
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">18</span><span style="color:#f1fa8c">    contexts: []
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">19</span><span style="color:#f1fa8c">    current-context: &#34;&#34;
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">20</span><span style="color:#f1fa8c">    kind: Config
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">21</span><span style="color:#f1fa8c">    preferences: {}
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">22</span><span style="color:#f1fa8c">    users: []</span>    
</code></pre></div><p>这一步主要是允许匿名用户访问上一步创建的CA的信息，然后就加入集群的时候使用。</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-yaml" data-lang="yaml"><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 1</span><span style="color:#6272a4"># I0403 11:30:26.116136   25657 loader.go:359] Config loaded from file /etc/kubernetes/admin.conf</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 2</span><span style="color:#6272a4"># I0403 11:30:26.116148   25657 clusterinfo.go:54] [bootstrap-token] copying the cluster from admin.conf to the bootstrap kubeconfig</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 3</span><span style="color:#6272a4"># I0403 11:30:26.116599   25657 clusterinfo.go:66][bootstrap-token] creating/updating ConfigMap in kube-public namespace</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 4</span><span style="color:#6272a4"># I0403 11:30:26.118774   25657 round_trippers.go:438] POST https://192.168.1.11:6443/api/v1/namespaces/kube-public/configmaps 201 Created in 2 milliseconds</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 5</span><span style="color:#6272a4"># I0403 11:30:26.118929   25657 clusterinfo.go:80] creating the RBAC rules for exposing the cluster-info ConfigMap in the kube-public namespace</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 6</span><span style="color:#6272a4"># I0403 11:30:26.124005   25657 round_trippers.go:438] POST https://192.168.1.11:6443/apis/rbac.authorization.k8s.io/v1/namespaces/kube-public/roles 201 Created in 4 milliseconds</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 7</span>---
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 8</span><span style="color:#ff79c6">kind</span>: Role
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 9</span><span style="color:#ff79c6">apiVersion</span>: rbac.authorization.k8s.io/v1
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">10</span><span style="color:#ff79c6">metadata</span>:
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">11</span>  <span style="color:#ff79c6">name</span>: kubeadm:bootstrap-signer-clusterinfo
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">12</span>  <span style="color:#ff79c6">namespace</span>: kube-public
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">13</span>  <span style="color:#ff79c6">selfLink</span>: <span style="color:#f1fa8c">&#34;/apis/rbac.authorization.k8s.io/v1/namespaces/kube-public/roles/kubeadm%3Abootstrap-signer-clusterinfo&#34;</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">14</span>  <span style="color:#ff79c6">uid</span>: 8770d896-59f2-11e9-9389-00163e132347
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">15</span>  <span style="color:#ff79c6">resourceVersion</span>: <span style="color:#f1fa8c">&#39;199&#39;</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">16</span>  <span style="color:#ff79c6">creationTimestamp</span>: <span style="color:#f1fa8c">&#39;2019-04-08T11:36:20Z&#39;</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">17</span><span style="color:#ff79c6">rules</span>:
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">18</span>- <span style="color:#ff79c6">verbs</span>:
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">19</span>  - get
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">20</span>  <span style="color:#ff79c6">apiGroups</span>:
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">21</span>  - <span style="color:#f1fa8c">&#39;&#39;</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">22</span>  <span style="color:#ff79c6">resources</span>:
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">23</span>  - configmaps
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">24</span>  <span style="color:#ff79c6">resourceNames</span>:
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">25</span>  - cluster-info
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">26</span><span style="color:#6272a4">#I0403 11:30:26.127798   25657 round_trippers.go:438] POST https://192.168.1.11:6443/apis/rbac.authorization.k8s.io/v1/namespaces/kube-public/rolebindings 201 Created in 3 milliseconds</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">27</span>---
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">28</span><span style="color:#ff79c6">kind</span>: RoleBinding
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">29</span><span style="color:#ff79c6">apiVersion</span>: rbac.authorization.k8s.io/v1
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">30</span><span style="color:#ff79c6">metadata</span>:
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">31</span>  <span style="color:#ff79c6">name</span>: kubeadm:bootstrap-signer-clusterinfo
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">32</span>  <span style="color:#ff79c6">namespace</span>: kube-public
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">33</span>  <span style="color:#ff79c6">selfLink</span>: <span style="color:#f1fa8c">&#34;/apis/rbac.authorization.k8s.io/v1/namespaces/kube-public/rolebindings/kubeadm%3Abootstrap-signer-clusterinfo&#34;</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">34</span>  <span style="color:#ff79c6">uid</span>: <span style="color:#bd93f9">87713973</span>-59f2-11e9-9389-00163e132347
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">35</span>  <span style="color:#ff79c6">resourceVersion</span>: <span style="color:#f1fa8c">&#39;200&#39;</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">36</span>  <span style="color:#ff79c6">creationTimestamp</span>: <span style="color:#f1fa8c">&#39;2019-04-08T11:36:20Z&#39;</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">37</span><span style="color:#ff79c6">subjects</span>:
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">38</span>- <span style="color:#ff79c6">kind</span>: User
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">39</span>  <span style="color:#ff79c6">apiGroup</span>: rbac.authorization.k8s.io
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">40</span>  <span style="color:#ff79c6">name</span>: system:anonymous
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">41</span><span style="color:#ff79c6">roleRef</span>:
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">42</span>  <span style="color:#ff79c6">apiGroup</span>: rbac.authorization.k8s.io
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">43</span>  <span style="color:#ff79c6">kind</span>: Role
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">44</span>  <span style="color:#ff79c6">name</span>: kubeadm:bootstrap-signer-clusterinfo
</code></pre></div><p>初始化Kube-proxy和Coredns</p>
<p>这个就不多说了，差不多都是sa，svc，deployment，role，rolebinding 五大件，然后就输出了相关信息。</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash"><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 1</span>Your Kubernetes control-plane has initialized successfully!
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 2</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 3</span>To start using your cluster, you need to run the following as a regular user:
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 4</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 5</span>  mkdir -p <span style="color:#8be9fd;font-style:italic">$HOME</span>/.kube
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 6</span>  sudo cp -i /etc/kubernetes/admin.conf <span style="color:#8be9fd;font-style:italic">$HOME</span>/.kube/config
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 7</span>  sudo chown <span style="color:#ff79c6">$(</span>id -u<span style="color:#ff79c6">)</span>:<span style="color:#ff79c6">$(</span>id -g<span style="color:#ff79c6">)</span> <span style="color:#8be9fd;font-style:italic">$HOME</span>/.kube/config
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 8</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 9</span>You should now deploy a pod network to the cluster.
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">10</span>Run <span style="color:#f1fa8c">&#34;kubectl apply -f [podnetwork].yaml&#34;</span> with one of the options listed at:
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">11</span>  https://kubernetes.io/docs/concepts/cluster-administration/addons/
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">12</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">13</span>Then you can join any number of worker nodes by running the following on each as root:
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">14</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">15</span>kubeadm join 192.168.1.11:6443 --token cr3n6a.5ndgdhxeyinfq7i0 <span style="color:#f1fa8c">\
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">16</span><span style="color:#f1fa8c"></span>    --discovery-token-ca-cert-hash sha256:3484008720a27ba243c825114b9a2373fb1d307d42818d23989b84ca698e7514
</code></pre></div><h2 id="node">node</h2>
<p>首先还是一大批检查，过检之后从cluster-info里面读取相应的证书信息；</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash"><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 1</span>I0402 23:30:52.707010    <span style="color:#bd93f9">2454</span> join.go:334<span style="color:#ff79c6">][</span>preflight<span style="color:#ff79c6">]</span> Fetching init configuration
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 2</span>I0402 23:30:52.707019    <span style="color:#bd93f9">2454</span> join.go:603<span style="color:#ff79c6">]</span> <span style="color:#ff79c6">[</span>join<span style="color:#ff79c6">]</span> Discovering cluster-info
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 3</span><span style="color:#ff79c6">[</span>discovery<span style="color:#ff79c6">]</span> Trying to connect to API Server <span style="color:#f1fa8c">&#34;192.168.1.11:6443&#34;</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 4</span><span style="color:#ff79c6">[</span>discovery<span style="color:#ff79c6">]</span> Created cluster-info discovery client, requesting info from <span style="color:#f1fa8c">&#34;https://192.168.1.11:6443&#34;</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 5</span>I0402 23:30:52.761085    <span style="color:#bd93f9">2454</span> round_trippers.go:438<span style="color:#ff79c6">]</span> GET https://192.168.1.11:6443/api/v1/namespaces/kube-public/configmaps/cluster-info <span style="color:#bd93f9">200</span> OK in <span style="color:#bd93f9">53</span> milliseconds
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 6</span><span style="color:#ff79c6">[</span>discovery<span style="color:#ff79c6">]</span> Requesting info from <span style="color:#f1fa8c">&#34;https://192.168.1.11:6443&#34;</span> again to validate TLS against the pinned public key
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 7</span>I0402 23:30:52.853292    <span style="color:#bd93f9">2454</span> round_trippers.go:438<span style="color:#ff79c6">]</span> GET https://192.168.1.11:6443/api/v1/namespaces/kube-public/configmaps/cluster-info <span style="color:#bd93f9">200</span> OK in <span style="color:#bd93f9">60</span> milliseconds
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 8</span><span style="color:#ff79c6">[</span>discovery<span style="color:#ff79c6">]</span> Cluster info signature and contents are valid and TLS certificate validates against pinned roots, will use API Server <span style="color:#f1fa8c">&#34;192.168.1.11:6443&#34;</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 9</span><span style="color:#ff79c6">[</span>discovery<span style="color:#ff79c6">]</span> Successfully established connection with API Server <span style="color:#f1fa8c">&#34;192.168.1.11:6443&#34;</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">10</span>I0402 23:30:52.854638    <span style="color:#bd93f9">2454</span> join.go:610<span style="color:#ff79c6">][</span>join<span style="color:#ff79c6">]</span> Retrieving KubeConfig objects
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">11</span>
</code></pre></div><p>接受相关配置信息，并写入本地，用token的参数创建bootstrap-kubeletconfig，重启kubelet读取相关配置。</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash"><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 1</span><span style="color:#ff79c6">[</span>join<span style="color:#ff79c6">]</span> Reading configuration from the cluster...
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 2</span><span style="color:#ff79c6">[</span>join<span style="color:#ff79c6">]</span> FYI: You can look at this config file with <span style="color:#f1fa8c">&#39;kubectl -n kube-system get cm kubeadm-config -oyaml&#39;</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 3</span>I0402 23:30:52.868021    <span style="color:#bd93f9">2454</span> round_trippers.go:438<span style="color:#ff79c6">]</span> GET https://192.168.1.11:6443/api/v1/namespaces/kube-system/configmaps/kubeadm-config <span style="color:#bd93f9">200</span> OK in <span style="color:#bd93f9">12</span> milliseconds
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 4</span>I0402 23:30:52.881050    <span style="color:#bd93f9">2454</span> round_trippers.go:438<span style="color:#ff79c6">]</span> GET https://192.168.1.11:6443/api/v1/namespaces/kube-system/configmaps/kubelet-config-1.13 <span style="color:#bd93f9">200</span> OK in <span style="color:#bd93f9">12</span> milliseconds
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 5</span>I0402 23:30:52.895260    <span style="color:#bd93f9">2454</span> round_trippers.go:438<span style="color:#ff79c6">]</span> GET https://192.168.1.11:6443/api/v1/namespaces/kube-system/configmaps/kube-proxy <span style="color:#bd93f9">200</span> OK in <span style="color:#bd93f9">12</span> milliseconds
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 6</span>I0402 23:30:52.897995    <span style="color:#bd93f9">2454</span> join.go:341<span style="color:#ff79c6">][</span>preflight<span style="color:#ff79c6">]</span> Running configuration dependant checks
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 7</span>I0402 23:30:52.898098    <span style="color:#bd93f9">2454</span> join.go:478<span style="color:#ff79c6">]</span> <span style="color:#ff79c6">[</span>join<span style="color:#ff79c6">]</span> writing bootstrap kubelet config file at /etc/kubernetes/bootstrap-kubelet.conf
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 8</span>I0402 23:30:52.979339    <span style="color:#bd93f9">2454</span> loader.go:359<span style="color:#ff79c6">]</span> Config loaded from file /etc/kubernetes/bootstrap-kubelet.conf
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 9</span>I0402 23:30:52.979784    <span style="color:#bd93f9">2454</span> join.go:503<span style="color:#ff79c6">]</span> Stopping the kubelet
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">10</span><span style="color:#ff79c6">[</span>kubelet<span style="color:#ff79c6">]</span> Downloading configuration <span style="color:#ff79c6">for</span> the kubelet from the <span style="color:#f1fa8c">&#34;kubelet-config-1.13&#34;</span> ConfigMap in the kube-system namespace
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">11</span>I0402 23:30:53.003579    <span style="color:#bd93f9">2454</span> round_trippers.go:438<span style="color:#ff79c6">]</span> GET https://192.168.1.11:6443/api/v1/namespaces/kube-system/configmaps/kubelet-config-1.13 <span style="color:#bd93f9">200</span> OK in <span style="color:#bd93f9">12</span> milliseconds
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">12</span><span style="color:#ff79c6">[</span>kubelet-start<span style="color:#ff79c6">]</span> Writing kubelet configuration to file <span style="color:#f1fa8c">&#34;/var/lib/kubelet/config.yaml&#34;</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">13</span><span style="color:#ff79c6">[</span>kubelet-start<span style="color:#ff79c6">]</span> Writing kubelet environment file with flags to file <span style="color:#f1fa8c">&#34;/var/lib/kubelet/kubeadm-flags.env&#34;</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">14</span>I0402 23:30:53.064636    <span style="color:#bd93f9">2454</span> join.go:520<span style="color:#ff79c6">]</span> Starting the kubelet
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">15</span><span style="color:#ff79c6">[</span>kubelet-start<span style="color:#ff79c6">]</span> Activating the kubelet service
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">16</span>
</code></pre></div><p>等待API Server 统一CSR，然后把自己注册到节点之中。</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash"><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1</span><span style="color:#ff79c6">[</span>tlsbootstrap<span style="color:#ff79c6">]</span> Waiting <span style="color:#ff79c6">for</span> the kubelet to perform the TLS Bootstrap...
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">2</span>I0402 23:30:54.229055    <span style="color:#bd93f9">2454</span> loader.go:359<span style="color:#ff79c6">]</span> Config loaded from file /etc/kubernetes/kubelet.conf
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">3</span>I0402 23:30:54.266377    <span style="color:#bd93f9">2454</span> loader.go:359<span style="color:#ff79c6">]</span> Config loaded from file /etc/kubernetes/kubelet.conf
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">4</span>I0402 23:30:54.267652    <span style="color:#bd93f9">2454</span> join.go:538<span style="color:#ff79c6">][</span>join<span style="color:#ff79c6">]</span> preserving the crisocket information <span style="color:#ff79c6">for</span> the node
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">5</span><span style="color:#ff79c6">[</span>patchnode<span style="color:#ff79c6">]</span> Uploading the CRI Socket information <span style="color:#f1fa8c">&#34;/var/run/dockershim.sock&#34;</span> to the Node API object <span style="color:#f1fa8c">&#34;thanos&#34;</span> as an annotation
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">6</span>I0402 23:30:54.829059    <span style="color:#bd93f9">2454</span> round_trippers.go:438<span style="color:#ff79c6">]</span> GET https://192.168.1.11:6443/api/v1/nodes/thanos <span style="color:#bd93f9">200</span> OK in <span style="color:#bd93f9">60</span> milliseconds
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">7</span>I0402 23:30:54.845547    <span style="color:#bd93f9">2454</span> round_trippers.go:438<span style="color:#ff79c6">]</span> PATCH https://192.168.1.11:6443/api/v1/nodes/thanos <span style="color:#bd93f9">200</span> OK in <span style="color:#bd93f9">13</span> milliseconds
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">8</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">9</span>
</code></pre></div><p>大功告成完成注册。</p>
<pre><code>This node has joined the cluster:

- Certificate signing request was sent to apiserver and a response was received.
- The Kubelet was informed of the new secure connection details.

Run 'kubectl get nodes' on the master to see this node join the cluster.

</code></pre><h2 id="附录">附录</h2>
<table>
<thead>
<tr>
<th style="text-align:left">协议</th>
<th style="text-align:left">方向</th>
<th style="text-align:left">端口</th>
<th style="text-align:left">说明</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:left">TCP</td>
<td style="text-align:left">Inbound</td>
<td style="text-align:left">16443*</td>
<td style="text-align:left">Load balancer Kubernetes API server port</td>
</tr>
<tr>
<td style="text-align:left">TCP</td>
<td style="text-align:left">Inbound</td>
<td style="text-align:left">6443*</td>
<td style="text-align:left">Kubernetes API server</td>
</tr>
<tr>
<td style="text-align:left">TCP</td>
<td style="text-align:left">Inbound</td>
<td style="text-align:left">4001</td>
<td style="text-align:left">etcd listen client port</td>
</tr>
<tr>
<td style="text-align:left">TCP</td>
<td style="text-align:left">Inbound</td>
<td style="text-align:left">2379-2380</td>
<td style="text-align:left">etcd server client API</td>
</tr>
<tr>
<td style="text-align:left">TCP</td>
<td style="text-align:left">Inbound</td>
<td style="text-align:left">10250</td>
<td style="text-align:left">Kubelet API</td>
</tr>
<tr>
<td style="text-align:left">TCP</td>
<td style="text-align:left">Inbound</td>
<td style="text-align:left">10251</td>
<td style="text-align:left">kube-scheduler</td>
</tr>
<tr>
<td style="text-align:left">TCP</td>
<td style="text-align:left">Inbound</td>
<td style="text-align:left">10252</td>
<td style="text-align:left">kube-controller-manager</td>
</tr>
<tr>
<td style="text-align:left">TCP</td>
<td style="text-align:left">Inbound</td>
<td style="text-align:left">10255</td>
<td style="text-align:left">Read-only Kubelet API (Deprecated)</td>
</tr>
<tr>
<td style="text-align:left">TCP</td>
<td style="text-align:left">Inbound</td>
<td style="text-align:left">30000-32767</td>
<td style="text-align:left">NodePort Services</td>
</tr>
<tr>
<td style="text-align:left">获取ca证书<code>sha256</code>编码hash值</td>
<td></td>
<td></td>
<td></td>
</tr>
</tbody>
</table>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash"><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1</span>openssl x509 -pubkey -in /etc/kubernetes/pki/ca.crt | openssl rsa -pubin 
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">2</span>-outform der 2&gt;/dev/null | openssl dgst -sha256 -hex | sed <span style="color:#f1fa8c">&#39;s/^.* //&#39;</span>
</code></pre></div><div class="highlight"><pre style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash"><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 1</span>root@master:/etc/kubernetes/pki# cat sa.pub
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 2</span>-----BEGIN PUBLIC KEY-----
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 3</span>MIIBIjANBgkqhkiG9w0BAQEFAAOCAQ8AMIIBCgKCAQEAystBIninWaQADb12t7p9
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 4</span>+9PoSGwzhvfhX1Pd9STxI5TKk8bSw5+I5apZJEi2FdZer5O9EtrxgDoUp9IBijyy
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 5</span>EgBbE+JwXd52IgKcSVkWaL8uACkqaxGAtUkxdofeVvp0PoK0sF+dmPDNLSGxH+MR
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 6</span>fF5qCzS4L0UQhAa35M/CR75mDFnKLUIphBGE5F8d8RxrOZAOPrqqqgvci5/TJq5K
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 7</span>jAwak2D1mzU7SJYedn0bvzwXPdXaiQjKHg1Fyi8Pw8utS6VEG2EZK1BKEXpkrz8n
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 8</span>4TZqZ5OajDZg/SjU79QV9W4OsF+WoR3eOPyr3DeSGkPXtG00ifbSgpx7pjV7CVoM
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 9</span>VQIDAQAB
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">10</span>-----END PUBLIC KEY-----
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">11</span>root@master:/etc/kubernetes/pki# openssl rsa -in ca.key -pubout
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">12</span>writing RSA key
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">13</span>-----BEGIN PUBLIC KEY-----
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">14</span>MIIBIjANBgkqhkiG9w0BAQEFAAOCAQ8AMIIBCgKCAQEA0mst0xEryhOLsiIB6MTy
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">15</span>yNjXKaFVFm8NafZUI+ZiRC7qFxsBsdT10OIKUIn5tFRUc7uxzcZzlRwJtwC7wrBe
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">16</span>4Jy1uN7VPrg5hgk7aqqdwtUFDhUVGtQOalFvqkVdVrolYCb+kDghjFR4chBNRng1
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">17</span>ldPuaGUCvyItltk8d5j68TDzf0V2LWDWdJnJ/k3GTK8PUlkYhrid8i5TyAmIO/A9
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">18</span>+rzQr8YCV1tnomodX88+jjjCZxXZ1np/dYtgo5XL7+zkWHucINbiVtG8sVI+sSkq
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">19</span>5fp4f/C7zGv78ieeRCWUjskaH1QoBVWCNug/r1qFe/G8Je1JGE+bMC4+YcYksXuq
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">20</span>WQIDAQAB
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">21</span>-----END PUBLIC KEY-----
</code></pre></div><h2 id="ref">Ref</h2>
<p>使用kubeadm安装kubernetes1.7/1.8/1.9</p>
<p><a href="https://blog.csdn.net/zhuchuangang/article/details/76572157">https://blog.csdn.net/zhuchuangang/article/details/76572157</a></p>
<p>Aliyun Repo</p>
<p><a href="https://www.jianshu.com/p/4b5f960a5bea">https://www.jianshu.com/p/4b5f960a5bea</a></p>
<p>使用kubeadm搭建Kubernetes(1.10.2)集群（国内环境）</p>
<p><a href="https://www.cnblogs.com/RainingNight/p/using-kubeadm-to-create-a-cluster.html">https://www.cnblogs.com/RainingNight/p/using-kubeadm-to-create-a-cluster.html</a></p>

    </div>
  </article>

  
  






  <div id="footer-post-container">
  <div id="footer-post">

    <div id="nav-footer" style="display: none">
      <ul>
         
          <li><a href="/">Home</a></li>
         
          <li><a href="/posts">Writings</a></li>
         
          <li><a href="/tags">Tags</a></li>
         
          <li><a href="/about">About</a></li>
        
      </ul>
    </div>

    
    <div id="toc-footer" style="display: none">
      <nav id="TableOfContents">
  <ul>
    <li><a href="#tldr">TL.DR</a></li>
    <li><a href="#一步一步装">一步一步装</a>
      <ul>
        <li><a href="#安装-docker">安装 Docker</a></li>
        <li><a href="#安装kubeadm">安装kubeadm</a></li>
        <li><a href="#准备工作">准备工作</a></li>
        <li><a href="#初始化静态pod">初始化静态pod</a></li>
        <li><a href="#生成的文件">生成的文件</a></li>
        <li><a href="#组件的启动参数">组件的启动参数</a>
          <ul>
            <li><a href="#manifestsetcdyaml">manifests/etcd.yaml</a></li>
            <li><a href="#manifestskube-apiserver">manifests/kube-apiserver</a></li>
            <li><a href="#kube-controller-manager">kube-controller-manager</a></li>
            <li><a href="#manifestskube-scheduler">manifests/kube-scheduler.</a></li>
            <li><a href="#查看状态">查看状态</a></li>
          </ul>
        </li>
      </ul>
    </li>
    <li><a href="#自定义配置">自定义配置</a></li>
    <li><a href="#master">Master</a></li>
    <li><a href="#node">node</a></li>
    <li><a href="#附录">附录</a></li>
    <li><a href="#ref">Ref</a></li>
  </ul>
</nav>
    </div>
    

    <div id="share-footer" style="display: none">
      
      <ul>
  
  
    
  
  
  <li>
    <a class="icon" href="http://www.facebook.com/sharer.php?u=https%3a%2f%2fexample.com%2fposts%2fcreate-cluster-use-kubeadm%2f" aria-label="Facebook">
      <i class="fab fa-facebook fa-lg" aria-hidden="true"></i>
    </a>
  </li>
  <li>
    <a class="icon" href="https://twitter.com/share?url=https%3a%2f%2fexample.com%2fposts%2fcreate-cluster-use-kubeadm%2f&text=%e4%bd%bf%e7%94%a8kubeadm%e5%88%9d%e5%a7%8b%e5%8c%96%e9%9b%86%e7%be%a4" aria-label="Twitter">
      <i class="fab fa-twitter fa-lg" aria-hidden="true"></i>
    </a>
  </li>
  <li>
    <a class="icon" href="http://www.linkedin.com/shareArticle?url=https%3a%2f%2fexample.com%2fposts%2fcreate-cluster-use-kubeadm%2f&title=%e4%bd%bf%e7%94%a8kubeadm%e5%88%9d%e5%a7%8b%e5%8c%96%e9%9b%86%e7%be%a4" aria-label="Linkedin">
      <i class="fab fa-linkedin fa-lg" aria-hidden="true"></i>
    </a>
  </li>
  <li>
    <a class="icon" href="https://pinterest.com/pin/create/bookmarklet/?url=https%3a%2f%2fexample.com%2fposts%2fcreate-cluster-use-kubeadm%2f&is_video=false&description=%e4%bd%bf%e7%94%a8kubeadm%e5%88%9d%e5%a7%8b%e5%8c%96%e9%9b%86%e7%be%a4" aria-label="Pinterest">
      <i class="fab fa-pinterest fa-lg" aria-hidden="true"></i>
    </a>
  </li>
  <li>
    <a class="icon" href="mailto:?subject=%e4%bd%bf%e7%94%a8kubeadm%e5%88%9d%e5%a7%8b%e5%8c%96%e9%9b%86%e7%be%a4&body=Check out this article: https%3a%2f%2fexample.com%2fposts%2fcreate-cluster-use-kubeadm%2f" aria-label="Email">
      <i class="fas fa-envelope fa-lg" aria-hidden="true"></i>
    </a>
  </li>
  <li>
    <a class="icon" href="https://getpocket.com/save?url=https%3a%2f%2fexample.com%2fposts%2fcreate-cluster-use-kubeadm%2f&title=%e4%bd%bf%e7%94%a8kubeadm%e5%88%9d%e5%a7%8b%e5%8c%96%e9%9b%86%e7%be%a4" aria-label="Pocket">
      <i class="fab fa-get-pocket fa-lg" aria-hidden="true"></i>
    </a>
  </li>
  <li>
    <a class="icon" href="http://reddit.com/submit?url=https%3a%2f%2fexample.com%2fposts%2fcreate-cluster-use-kubeadm%2f&title=%e4%bd%bf%e7%94%a8kubeadm%e5%88%9d%e5%a7%8b%e5%8c%96%e9%9b%86%e7%be%a4" aria-label="reddit">
      <i class="fab fa-reddit fa-lg" aria-hidden="true"></i>
    </a>
  </li>
  <li>
    <a class="icon" href="http://www.tumblr.com/share/link?url=https%3a%2f%2fexample.com%2fposts%2fcreate-cluster-use-kubeadm%2f&name=%e4%bd%bf%e7%94%a8kubeadm%e5%88%9d%e5%a7%8b%e5%8c%96%e9%9b%86%e7%be%a4&description=%e5%be%88%e4%b9%85%e4%b9%8b%e5%89%8d%e5%b0%b1%e5%86%99%e8%bf%87%e8%bf%99%e7%af%87%e7%ac%94%e8%ae%b0%ef%bc%8c%e4%b8%80%e7%9b%b4%e6%b2%a1%e5%8f%91%e5%87%ba%e6%9d%a5%ef%bc%8c%e8%99%bd%e8%af%b4%e8%bf%99%e6%a0%b7%e7%9a%84%e6%96%87%e7%ab%a0%e5%b7%ae%e4%b8%8d%e5%a4%9a%e5%b7%b2%e7%bb%8f%e7%83%82%e5%a4%a7%e8%a1%97%e4%ba%86%ef%bc%8c%e8%bf%98%e6%98%af%e5%8f%af%e4%bb%a5%e7%9c%8b%e4%b8%80%e4%b8%8b%e7%9a%84%e3%80%82%0a1%e2%8e%88%e2%8e%88%202apt%20install%20-y%20bash-completion%203yum%20install%20-y%20bash-completion%204echo%20%26%2334%3bsource%20%26lt%3b%28kubectl%20completion%20bash%29%26%2334%3b%20%26gt%3b%26gt%3b%20~%2f.bashrc%205echo%20%26%2334%3bsource%20%26lt%3b%28kubeadm%20completion%20bash%29%26%2334%3b%20%26gt%3b%26gt%3b%20~%2f.bashrc%206source%20~%2f.bashrc%207modprobe%20ip_vs%20%26amp%3b%26amp%3b%20modprobe%20ip_vs_rr%20%26amp%3b%26amp%3b%20modprobe%20ip_vs_wrr%20%26amp%3b%26amp%3b%20modprobe%20ip_vs_sh%208rm%20-rf%20%2fvar%2flib%2fcni%2f%209rm%20-rf%20%2fvar%2flib%2fkubelet%2f%2a%2010rm%20-rf%20%2fetc%2fcni%2f%2011ip%20link%20del%20cni0%20%26amp%3b%26amp%3b%20ip%20link%20del%20flannel.1%20%26amp%3b%26amp%3b%20ip%20link%20del%20kube-ipvs0%2012net.ipv6.conf.all.disable_ipv6%20%3d%201%2013awk%20%26%2339%3b%242%20~%20path%20%7bprint%20%242%7d%26%2339%3b%20path%3d%2fvar%2flib%2fkubelet%20%2fproc%2fmounts%20%7c%20xargs%20-r%20umount%2014kubeadm%20init%20--kubernetes-version%201." aria-label="Tumblr">
      <i class="fab fa-tumblr fa-lg" aria-hidden="true"></i>
    </a>
  </li>
  <li>
    <a class="icon" href="https://news.ycombinator.com/submitlink?u=https%3a%2f%2fexample.com%2fposts%2fcreate-cluster-use-kubeadm%2f&t=%e4%bd%bf%e7%94%a8kubeadm%e5%88%9d%e5%a7%8b%e5%8c%96%e9%9b%86%e7%be%a4" aria-label="Hacker News">
      <i class="fab fa-hacker-news fa-lg" aria-hidden="true"></i>
    </a>
  </li>
</ul>

    </div>

    <div id="actions-footer">
      
        <a id="menu-toggle" class="icon" href="#" onclick="$('#nav-footer').toggle();return false;" aria-label="Menu">
          <i class="fas fa-bars fa-lg" aria-hidden="true"></i> Menu</a>
        
        <a id="toc-toggle" class="icon" href="#" onclick="$('#toc-footer').toggle();return false;" aria-label="TOC">
          <i class="fas fa-list fa-lg" aria-hidden="true"></i> TOC</a>
        
        <a id="share-toggle" class="icon" href="#" onclick="$('#share-footer').toggle();return false;" aria-label="Share">
          <i class="fas fa-share-alt fa-lg" aria-hidden="true"></i> share</a>
        <a id="top" style="display:none" class="icon" href="#" onclick="$('html, body').animate({ scrollTop: 0 }, 'fast');" aria-label="Top of Page">
          <i class="fas fa-chevron-up fa-lg" aria-hidden="true"></i> Top</a>
    </div>

  </div>
</div>


  <footer id="footer">
  <div class="footer-left">
    Copyright  &copy; 2025  You 
  </div>
  <div class="footer-right">
    <nav>
      <ul>
         
        <li><a href="/">Home</a></li>
         
        <li><a href="/posts">Writings</a></li>
         
        <li><a href="/tags">Tags</a></li>
         
        <li><a href="/about">About</a></li>
        
      </ul>
    </nav>
  </div>
</footer>


  </div>
</body>

<link rel="stylesheet" href=/lib/font-awesome/css/all.min.css>
<script src=/lib/jquery/jquery.min.js></script>
<script src=/js/main.js></script>

<script src=/js/code-copy.js></script>




</html>
