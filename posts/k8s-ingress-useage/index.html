<!DOCTYPE html>
<html lang="en-us">
<head>
  <link rel="preload" href="/lib/font-awesome/webfonts/fa-brands-400.woff2" as="font" type="font/woff2" crossorigin="anonymous">
  <link rel="preload" href="/lib/font-awesome/webfonts/fa-regular-400.woff2" as="font" type="font/woff2" crossorigin="anonymous">
  <link rel="preload" href="/lib/font-awesome/webfonts/fa-solid-900.woff2" as="font" type="font/woff2" crossorigin="anonymous">
  <link rel="preload" href="/lib/JetBrainsMono/web/woff2/JetBrainsMono-Regular.woff2" as="font" type="font/woff2" crossorigin="anonymous">
  <script type="text/javascript" src="https://latest.cactus.chat/cactus.js"></script>
  <link rel="stylesheet" href="https://latest.cactus.chat/style.css" type="text/css">
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <title> k8s 七层访问入口 Ingress | Cactus theme example</title>
  <link rel = 'canonical' href = 'https://example.com/posts/k8s-ingress-useage/'>
  <meta name="description" content="随便记录点东西">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <meta name="robots" content="all,follow">
  <meta name="googlebot" content="index,follow,snippet,archive">
  <meta property="og:title" content="k8s 七层访问入口 Ingress" />
<meta property="og:description" content="k8s初期的时候，只有Service作为四层负载均衡，后来才推出了专门用作七层的负载均衡&ndash;Ingress。第一批实现Ingress Controller的就是traefik以及Nginx Ingress，后来随着Envory的出现，也逐渐涌现出了越来越多的Ingress Controller实现，比如：
 https://github.com/heptio/contour https://github.com/datawire/ambassador https://github.com/istio/istio/  但是这些实现的原理说到底就是watch后端的Service，然后创建对于的访问规则。
Install 以Nginx Ingress为例，由Go，Lua和C三种语言组成，Go负责与k8s API交互，下面简单介绍一些安装过程。
1#首先安装控制器， 2kubectl apply -f https://raw.githubusercontent.com/kubernetes/ingress-nginx/master/deploy/mandatory.yaml 3#然后创建Service 4kubectl apply -f https://raw.githubusercontent.com/kubernetes/ingress-nginx/master/deploy/provider/baremetal/service-nodeport.yaml 以上是属于Bate-metal的配置，如果你是在Public CLoud可以替换为LoadBalancer。仔细观察一下第一个yaml文件，可以发现有些特殊的地方，如下所示，有一个特殊的annotations，看来和APIServer类似，支持多副本高可用。
I0411 09:11:06.783582 7 leaderelection.go:227] successfully acquired lease ingress-nginx/ingress-controller-leader-nginx
1kubectl -n ingress-nginx get cm ingress-controller-leader-nginx -oyaml 2apiVersion: v1 3kind: ConfigMap 4metadata: 5 annotations: 6 control-plane.alpha.kubernetes.io/leader: &#39;{&#34;holderIdentity&#34;:&#34;nginx-ingress-controller-85f9f75759-4wb8k&#34;,&#34;leaseDurationSeconds&#34;:30,&#34;acquireTime&#34;:&#34;2019-04-11T09:11:06Z&#34;,&#34;renewTime&#34;:&#34;2019-04-11T13:12:56Z&#34;,&#34;leaderTransitions&#34;:0}&#39; 7 creationTimestamp: &#34;2019-04-11T09:11:06Z&#34; 8 name: ingress-controller-leader-nginx 9 namespace: ingress-nginx 10 resourceVersion: &#34;28998&#34; 11 selfLink: /api/v1/namespaces/ingress-nginx/configmaps/ingress-controller-leader-nginx 12 uid: bd25d320-5c39-11e9-af65-00163e132347 因为Nginx原生支持四层负载均衡，所有Nginx Ingress也是支持四层的。" />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://example.com/posts/k8s-ingress-useage/" />
<meta property="article:published_time" content="2019-03-12T22:31:20+08:00" />
<meta property="article:modified_time" content="2019-03-12T22:31:20+08:00" />

  <meta name="twitter:card" content="summary"/>
<meta name="twitter:title" content="k8s 七层访问入口 Ingress"/>
<meta name="twitter:description" content="k8s初期的时候，只有Service作为四层负载均衡，后来才推出了专门用作七层的负载均衡&ndash;Ingress。第一批实现Ingress Controller的就是traefik以及Nginx Ingress，后来随着Envory的出现，也逐渐涌现出了越来越多的Ingress Controller实现，比如：
 https://github.com/heptio/contour https://github.com/datawire/ambassador https://github.com/istio/istio/  但是这些实现的原理说到底就是watch后端的Service，然后创建对于的访问规则。
Install 以Nginx Ingress为例，由Go，Lua和C三种语言组成，Go负责与k8s API交互，下面简单介绍一些安装过程。
1#首先安装控制器， 2kubectl apply -f https://raw.githubusercontent.com/kubernetes/ingress-nginx/master/deploy/mandatory.yaml 3#然后创建Service 4kubectl apply -f https://raw.githubusercontent.com/kubernetes/ingress-nginx/master/deploy/provider/baremetal/service-nodeport.yaml 以上是属于Bate-metal的配置，如果你是在Public CLoud可以替换为LoadBalancer。仔细观察一下第一个yaml文件，可以发现有些特殊的地方，如下所示，有一个特殊的annotations，看来和APIServer类似，支持多副本高可用。
I0411 09:11:06.783582 7 leaderelection.go:227] successfully acquired lease ingress-nginx/ingress-controller-leader-nginx
1kubectl -n ingress-nginx get cm ingress-controller-leader-nginx -oyaml 2apiVersion: v1 3kind: ConfigMap 4metadata: 5 annotations: 6 control-plane.alpha.kubernetes.io/leader: &#39;{&#34;holderIdentity&#34;:&#34;nginx-ingress-controller-85f9f75759-4wb8k&#34;,&#34;leaseDurationSeconds&#34;:30,&#34;acquireTime&#34;:&#34;2019-04-11T09:11:06Z&#34;,&#34;renewTime&#34;:&#34;2019-04-11T13:12:56Z&#34;,&#34;leaderTransitions&#34;:0}&#39; 7 creationTimestamp: &#34;2019-04-11T09:11:06Z&#34; 8 name: ingress-controller-leader-nginx 9 namespace: ingress-nginx 10 resourceVersion: &#34;28998&#34; 11 selfLink: /api/v1/namespaces/ingress-nginx/configmaps/ingress-controller-leader-nginx 12 uid: bd25d320-5c39-11e9-af65-00163e132347 因为Nginx原生支持四层负载均衡，所有Nginx Ingress也是支持四层的。"/>

  
  
    
  
  
  <link rel="stylesheet" href="https://example.com/css/styles.b7d947e05a1170a37e8b82db035a37baf568e98c7fcbe3f9dd31eac5e6a72150f9f731721fa60a1b3eed4c6a9db9c5a706d396767b698198aeea1614f88ce960.css" integrity="sha512-t9lH4FoRcKN&#43;i4LbA1o3uvVo6Yx/y&#43;P53THqxeanIVD59zFyH6YKGz7tTGqducWnBtOWdntpgZiu6hYU&#43;IzpYA=="> 

  
  
  
    <!--[if lt IE 9]>
      <script src="https://oss.maxcdn.com/html5shiv/3.7.2/html5shiv.min.js"></script>
      <script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
    <![endif]-->
  

  
<link rel="icon" type="image/png" href="https://example.com/images/favicon.ico" />

  
  
  
  
</head>

<body class="max-width mx-auto px3 ltr">
  <div class="content index py4">

  <div id="header-post">
  <a id="menu-icon" href="#"><i class="fas fa-bars fa-lg"></i></a>
  <a id="menu-icon-tablet" href="#"><i class="fas fa-bars fa-lg"></i></a>
  <a id="top-icon-tablet" href="#" onclick="$('html, body').animate({ scrollTop: 0 }, 'fast');" style="display:none;" aria-label="Top of Page"><i class="fas fa-chevron-up fa-lg"></i></a>
  <span id="menu">
    <span id="nav">
      <ul>
         
        <li><a href="/">Home</a></li>
         
        <li><a href="/posts">Writings</a></li>
         
        <li><a href="/tags">Tags</a></li>
         
        <li><a href="/about">About</a></li>
        
      </ul>
    </span>
    <br/>
    <span id="actions">
      <ul>
        
        <li>
          <a class="icon" href=" https://example.com/posts/kubernetes-network-flannel/" aria-label="Previous">
            <i class="fas fa-chevron-left" aria-hidden="true" onmouseover="$('#i-prev').toggle();" onmouseout="$('#i-prev').toggle();"></i>
          </a>
        </li>
        
        
        <li>
          <a class="icon" href="https://example.com/posts/k8s-event-explorer/" aria-label="Next">
            <i class="fas fa-chevron-right" aria-hidden="true" onmouseover="$('#i-next').toggle();" onmouseout="$('#i-next').toggle();"></i>
          </a>
        </li>
        
        <li>
          <a class="icon" href="#" onclick="$('html, body').animate({ scrollTop: 0 }, 'fast');" aria-label="Top of Page">
            <i class="fas fa-chevron-up" aria-hidden="true" onmouseover="$('#i-top').toggle();" onmouseout="$('#i-top').toggle();"></i>
          </a>
        </li>
        <li>
          <a class="icon" href="#" aria-label="Share">
            <i class="fas fa-share-alt" aria-hidden="true" onmouseover="$('#i-share').toggle();" onmouseout="$('#i-share').toggle();" onclick="$('#share').toggle();return false;"></i>
          </a>
        </li>
      </ul>
      <span id="i-prev" class="info" style="display:none;">Previous post</span>
      <span id="i-next" class="info" style="display:none;">Next post</span>
      <span id="i-top" class="info" style="display:none;">Back to top</span>
      <span id="i-share" class="info" style="display:none;">Share post</span>
    </span>
    <br/>
    <div id="share" style="display: none">
      
      <ul>
  
  
    
  
  
  <li>
    <a class="icon" href="http://www.facebook.com/sharer.php?u=https%3a%2f%2fexample.com%2fposts%2fk8s-ingress-useage%2f" aria-label="Facebook">
      <i class="fab fa-facebook " aria-hidden="true"></i>
    </a>
  </li>
  <li>
    <a class="icon" href="https://twitter.com/share?url=https%3a%2f%2fexample.com%2fposts%2fk8s-ingress-useage%2f&text=k8s%20%e4%b8%83%e5%b1%82%e8%ae%bf%e9%97%ae%e5%85%a5%e5%8f%a3%20Ingress" aria-label="Twitter">
      <i class="fab fa-twitter " aria-hidden="true"></i>
    </a>
  </li>
  <li>
    <a class="icon" href="http://www.linkedin.com/shareArticle?url=https%3a%2f%2fexample.com%2fposts%2fk8s-ingress-useage%2f&title=k8s%20%e4%b8%83%e5%b1%82%e8%ae%bf%e9%97%ae%e5%85%a5%e5%8f%a3%20Ingress" aria-label="Linkedin">
      <i class="fab fa-linkedin " aria-hidden="true"></i>
    </a>
  </li>
  <li>
    <a class="icon" href="https://pinterest.com/pin/create/bookmarklet/?url=https%3a%2f%2fexample.com%2fposts%2fk8s-ingress-useage%2f&is_video=false&description=k8s%20%e4%b8%83%e5%b1%82%e8%ae%bf%e9%97%ae%e5%85%a5%e5%8f%a3%20Ingress" aria-label="Pinterest">
      <i class="fab fa-pinterest " aria-hidden="true"></i>
    </a>
  </li>
  <li>
    <a class="icon" href="mailto:?subject=k8s%20%e4%b8%83%e5%b1%82%e8%ae%bf%e9%97%ae%e5%85%a5%e5%8f%a3%20Ingress&body=Check out this article: https%3a%2f%2fexample.com%2fposts%2fk8s-ingress-useage%2f" aria-label="Email">
      <i class="fas fa-envelope " aria-hidden="true"></i>
    </a>
  </li>
  <li>
    <a class="icon" href="https://getpocket.com/save?url=https%3a%2f%2fexample.com%2fposts%2fk8s-ingress-useage%2f&title=k8s%20%e4%b8%83%e5%b1%82%e8%ae%bf%e9%97%ae%e5%85%a5%e5%8f%a3%20Ingress" aria-label="Pocket">
      <i class="fab fa-get-pocket " aria-hidden="true"></i>
    </a>
  </li>
  <li>
    <a class="icon" href="http://reddit.com/submit?url=https%3a%2f%2fexample.com%2fposts%2fk8s-ingress-useage%2f&title=k8s%20%e4%b8%83%e5%b1%82%e8%ae%bf%e9%97%ae%e5%85%a5%e5%8f%a3%20Ingress" aria-label="reddit">
      <i class="fab fa-reddit " aria-hidden="true"></i>
    </a>
  </li>
  <li>
    <a class="icon" href="http://www.tumblr.com/share/link?url=https%3a%2f%2fexample.com%2fposts%2fk8s-ingress-useage%2f&name=k8s%20%e4%b8%83%e5%b1%82%e8%ae%bf%e9%97%ae%e5%85%a5%e5%8f%a3%20Ingress&description=k8s%e5%88%9d%e6%9c%9f%e7%9a%84%e6%97%b6%e5%80%99%ef%bc%8c%e5%8f%aa%e6%9c%89Service%e4%bd%9c%e4%b8%ba%e5%9b%9b%e5%b1%82%e8%b4%9f%e8%bd%bd%e5%9d%87%e8%a1%a1%ef%bc%8c%e5%90%8e%e6%9d%a5%e6%89%8d%e6%8e%a8%e5%87%ba%e4%ba%86%e4%b8%93%e9%97%a8%e7%94%a8%e4%bd%9c%e4%b8%83%e5%b1%82%e7%9a%84%e8%b4%9f%e8%bd%bd%e5%9d%87%e8%a1%a1%26ndash%3bIngress%e3%80%82%e7%ac%ac%e4%b8%80%e6%89%b9%e5%ae%9e%e7%8e%b0Ingress%20Controller%e7%9a%84%e5%b0%b1%e6%98%aftraefik%e4%bb%a5%e5%8f%8aNginx%20Ingress%ef%bc%8c%e5%90%8e%e6%9d%a5%e9%9a%8f%e7%9d%80Envory%e7%9a%84%e5%87%ba%e7%8e%b0%ef%bc%8c%e4%b9%9f%e9%80%90%e6%b8%90%e6%b6%8c%e7%8e%b0%e5%87%ba%e4%ba%86%e8%b6%8a%e6%9d%a5%e8%b6%8a%e5%a4%9a%e7%9a%84Ingress%20Controller%e5%ae%9e%e7%8e%b0%ef%bc%8c%e6%af%94%e5%a6%82%ef%bc%9a%0a%20https%3a%2f%2fgithub.com%2fheptio%2fcontour%20https%3a%2f%2fgithub.com%2fdatawire%2fambassador%20https%3a%2f%2fgithub.com%2fistio%2fistio%2f%20%20%e4%bd%86%e6%98%af%e8%bf%99%e4%ba%9b%e5%ae%9e%e7%8e%b0%e7%9a%84%e5%8e%9f%e7%90%86%e8%af%b4%e5%88%b0%e5%ba%95%e5%b0%b1%e6%98%afwatch%e5%90%8e%e7%ab%af%e7%9a%84Service%ef%bc%8c%e7%84%b6%e5%90%8e%e5%88%9b%e5%bb%ba%e5%af%b9%e4%ba%8e%e7%9a%84%e8%ae%bf%e9%97%ae%e8%a7%84%e5%88%99%e3%80%82%0aInstall%20%e4%bb%a5Nginx%20Ingress%e4%b8%ba%e4%be%8b%ef%bc%8c%e7%94%b1Go%ef%bc%8cLua%e5%92%8cC%e4%b8%89%e7%a7%8d%e8%af%ad%e8%a8%80%e7%bb%84%e6%88%90%ef%bc%8cGo%e8%b4%9f%e8%b4%a3%e4%b8%8ek8s%20API%e4%ba%a4%e4%ba%92%ef%bc%8c%e4%b8%8b%e9%9d%a2%e7%ae%80%e5%8d%95%e4%bb%8b%e7%bb%8d%e4%b8%80%e4%ba%9b%e5%ae%89%e8%a3%85%e8%bf%87%e7%a8%8b%e3%80%82%0a1%23%e9%a6%96%e5%85%88%e5%ae%89%e8%a3%85%e6%8e%a7%e5%88%b6%e5%99%a8%ef%bc%8c%202kubectl%20apply%20-f%20https%3a%2f%2fraw.githubusercontent.com%2fkubernetes%2fingress-nginx%2fmaster%2fdeploy%2fmandatory.yaml%203%23%e7%84%b6%e5%90%8e%e5%88%9b%e5%bb%baService%204kubectl%20apply%20-f%20https%3a%2f%2fraw.githubusercontent.com%2fkubernetes%2fingress-nginx%2fmaster%2fdeploy%2fprovider%2fbaremetal%2fservice-nodeport.yaml%20%e4%bb%a5%e4%b8%8a%e6%98%af%e5%b1%9e%e4%ba%8eBate-metal%e7%9a%84%e9%85%8d%e7%bd%ae%ef%bc%8c%e5%a6%82%e6%9e%9c%e4%bd%a0%e6%98%af%e5%9c%a8Public%20CLoud%e5%8f%af%e4%bb%a5%e6%9b%bf%e6%8d%a2%e4%b8%baLoadBalancer%e3%80%82%e4%bb%94%e7%bb%86%e8%a7%82%e5%af%9f%e4%b8%80%e4%b8%8b%e7%ac%ac%e4%b8%80%e4%b8%aayaml%e6%96%87%e4%bb%b6%ef%bc%8c%e5%8f%af%e4%bb%a5%e5%8f%91%e7%8e%b0%e6%9c%89%e4%ba%9b%e7%89%b9%e6%ae%8a%e7%9a%84%e5%9c%b0%e6%96%b9%ef%bc%8c%e5%a6%82%e4%b8%8b%e6%89%80%e7%a4%ba%ef%bc%8c%e6%9c%89%e4%b8%80%e4%b8%aa%e7%89%b9%e6%ae%8a%e7%9a%84annotations%ef%bc%8c%e7%9c%8b%e6%9d%a5%e5%92%8cAPIServer%e7%b1%bb%e4%bc%bc%ef%bc%8c%e6%94%af%e6%8c%81%e5%a4%9a%e5%89%af%e6%9c%ac%e9%ab%98%e5%8f%af%e7%94%a8%e3%80%82%0aI0411%2009%3a11%3a06.783582%207%20leaderelection.go%3a227%5d%20successfully%20acquired%20lease%20ingress-nginx%2fingress-controller-leader-nginx%0a1kubectl%20-n%20ingress-nginx%20get%20cm%20ingress-controller-leader-nginx%20-oyaml%202apiVersion%3a%20v1%203kind%3a%20ConfigMap%204metadata%3a%205%20annotations%3a%206%20control-plane.alpha.kubernetes.io%2fleader%3a%20%26%2339%3b%7b%26%2334%3bholderIdentity%26%2334%3b%3a%26%2334%3bnginx-ingress-controller-85f9f75759-4wb8k%26%2334%3b%2c%26%2334%3bleaseDurationSeconds%26%2334%3b%3a30%2c%26%2334%3bacquireTime%26%2334%3b%3a%26%2334%3b2019-04-11T09%3a11%3a06Z%26%2334%3b%2c%26%2334%3brenewTime%26%2334%3b%3a%26%2334%3b2019-04-11T13%3a12%3a56Z%26%2334%3b%2c%26%2334%3bleaderTransitions%26%2334%3b%3a0%7d%26%2339%3b%207%20creationTimestamp%3a%20%26%2334%3b2019-04-11T09%3a11%3a06Z%26%2334%3b%208%20name%3a%20ingress-controller-leader-nginx%209%20namespace%3a%20ingress-nginx%2010%20resourceVersion%3a%20%26%2334%3b28998%26%2334%3b%2011%20selfLink%3a%20%2fapi%2fv1%2fnamespaces%2fingress-nginx%2fconfigmaps%2fingress-controller-leader-nginx%2012%20uid%3a%20bd25d320-5c39-11e9-af65-00163e132347%20%e5%9b%a0%e4%b8%baNginx%e5%8e%9f%e7%94%9f%e6%94%af%e6%8c%81%e5%9b%9b%e5%b1%82%e8%b4%9f%e8%bd%bd%e5%9d%87%e8%a1%a1%ef%bc%8c%e6%89%80%e6%9c%89Nginx%20Ingress%e4%b9%9f%e6%98%af%e6%94%af%e6%8c%81%e5%9b%9b%e5%b1%82%e7%9a%84%e3%80%82" aria-label="Tumblr">
      <i class="fab fa-tumblr " aria-hidden="true"></i>
    </a>
  </li>
  <li>
    <a class="icon" href="https://news.ycombinator.com/submitlink?u=https%3a%2f%2fexample.com%2fposts%2fk8s-ingress-useage%2f&t=k8s%20%e4%b8%83%e5%b1%82%e8%ae%bf%e9%97%ae%e5%85%a5%e5%8f%a3%20Ingress" aria-label="Hacker News">
      <i class="fab fa-hacker-news " aria-hidden="true"></i>
    </a>
  </li>
</ul>

    </div>
    
    <div id="toc">
      <nav id="TableOfContents">
  <ul>
    <li><a href="#install">Install</a></li>
    <li><a href="#配置">配置</a>
      <ul>
        <li><a href="#最简单的">最简单的</a></li>
        <li><a href="#多host">多host</a></li>
        <li><a href="#https">https</a></li>
        <li><a href="#前后端分离">前后端分离</a></li>
      </ul>
    </li>
    <li><a href="#进阶">进阶</a></li>
    <li><a href="#access-log">Access Log</a></li>
    <li><a href="#ref">Ref</a></li>
  </ul>
</nav>
    </div>
    
  </span>
</div>


  <article class="post" itemscope itemtype="http://schema.org/BlogPosting">
    <header>
      <h1 class="posttitle" itemprop="name headline">
        k8s 七层访问入口 Ingress
      </h1>
      <div class="meta">
        
        <div class="postdate">
          
          <time datetime="2019-03-12 22:31:20 &#43;0800 CST" itemprop="datePublished">2019-03-12</time>
          
        </div>
        
        
        <div class="article-read-time">
          <i class="far fa-clock"></i>
          
          9 minute read
        </div>
        
        
        
        <div class="article-tag">
            <i class="fas fa-tag"></i>
            
            
            <a class="tag-link" href="/tags/k8s" rel="tag">k8s</a>
            
        </div>
        
      </div>
    </header>

  
    
    <div class="content" itemprop="articleBody">
      <p>k8s初期的时候，只有Service作为四层负载均衡，后来才推出了专门用作七层的负载均衡&ndash;Ingress。第一批实现Ingress Controller的就是traefik以及Nginx Ingress，后来随着Envory的出现，也逐渐涌现出了越来越多的Ingress Controller实现，比如：</p>
<ol>
<li><a href="https://github.com/heptio/contour">https://github.com/heptio/contour</a></li>
<li><a href="https://github.com/datawire/ambassador">https://github.com/datawire/ambassador</a></li>
<li><a href="https://github.com/istio/istio/">https://github.com/istio/istio/</a></li>
</ol>
<p>但是这些实现的原理说到底就是watch后端的Service，然后创建对于的访问规则。</p>
<h2 id="install">Install</h2>
<p>以Nginx Ingress为例，由Go，Lua和C三种语言组成，Go负责与k8s API交互，下面简单介绍一些安装过程。</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash"><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1</span><span style="color:#6272a4">#首先安装控制器，</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">2</span>kubectl apply -f https://raw.githubusercontent.com/kubernetes/ingress-nginx/master/deploy/mandatory.yaml
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">3</span><span style="color:#6272a4">#然后创建Service</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">4</span>kubectl apply -f https://raw.githubusercontent.com/kubernetes/ingress-nginx/master/deploy/provider/baremetal/service-nodeport.yaml
</code></pre></div><p>以上是属于Bate-metal的配置，如果你是在Public CLoud可以替换为LoadBalancer。仔细观察一下第一个yaml文件，可以发现有些特殊的地方，如下所示，有一个特殊的annotations，看来和APIServer类似，支持多副本高可用。</p>
<p><code>I0411 09:11:06.783582       7 leaderelection.go:227] successfully acquired lease ingress-nginx/ingress-controller-leader-nginx</code></p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-yaml" data-lang="yaml"><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 1</span>kubectl -n ingress-nginx get cm ingress-controller-leader-nginx -oyaml
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 2</span><span style="color:#ff79c6">apiVersion</span>: v1
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 3</span><span style="color:#ff79c6">kind</span>: ConfigMap
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 4</span><span style="color:#ff79c6">metadata</span>:
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 5</span>  <span style="color:#ff79c6">annotations</span>:
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 6</span>    <span style="color:#ff79c6">control-plane.alpha.kubernetes.io/leader</span>: <span style="color:#f1fa8c">&#39;{&#34;holderIdentity&#34;:&#34;nginx-ingress-controller-85f9f75759-4wb8k&#34;,&#34;leaseDurationSeconds&#34;:30,&#34;acquireTime&#34;:&#34;2019-04-11T09:11:06Z&#34;,&#34;renewTime&#34;:&#34;2019-04-11T13:12:56Z&#34;,&#34;leaderTransitions&#34;:0}&#39;</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 7</span>  <span style="color:#ff79c6">creationTimestamp</span>: <span style="color:#f1fa8c">&#34;2019-04-11T09:11:06Z&#34;</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 8</span>  <span style="color:#ff79c6">name</span>: ingress-controller-leader-nginx
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 9</span>  <span style="color:#ff79c6">namespace</span>: ingress-nginx
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">10</span>  <span style="color:#ff79c6">resourceVersion</span>: <span style="color:#f1fa8c">&#34;28998&#34;</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">11</span>  <span style="color:#ff79c6">selfLink</span>: /api/v1/namespaces/ingress-nginx/configmaps/ingress-controller-leader-nginx
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">12</span>  <span style="color:#ff79c6">uid</span>: bd25d320-5c39-11e9-af65-00163e132347
</code></pre></div><p>因为Nginx原生支持四层负载均衡，所有Nginx Ingress也是支持四层的。</p>
<p>除此之外k8s也支持多Ingress比如同时安装traefik和Nginx，Nginx Ingress 也支持多Ingress，比如一个内网一个外网。(<a href="https://yq.aliyun.com/articles/645856">https://yq.aliyun.com/articles/645856</a>)</p>
<h2 id="配置">配置</h2>
<p>对于k8s来说，当你需要一个访问入口的时候，就需要声明一个Ingress资源，如下所示</p>
<h3 id="最简单的">最简单的</h3>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-yaml" data-lang="yaml"><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 1</span><span style="color:#ff79c6">apiVersion</span>: extensions/v1beta1
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 2</span><span style="color:#ff79c6">kind</span>: Ingress
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 3</span><span style="color:#ff79c6">metadata</span>:
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 4</span>  <span style="color:#ff79c6">name</span>: nginx
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 5</span>  <span style="color:#ff79c6">annotations</span>:
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 6</span>    <span style="color:#6272a4"># 这个在多ingress时才需要配置</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 7</span>    <span style="color:#ff79c6">kubernetes.io/ingress.class</span>: <span style="color:#f1fa8c">&#34;nginx&#34;</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 8</span><span style="color:#ff79c6">spec</span>:
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 9</span>  <span style="color:#ff79c6">rules</span>:
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">10</span>  - <span style="color:#ff79c6">host</span>: ing.vsxen.me
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">11</span>    <span style="color:#ff79c6">http</span>:
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">12</span>      <span style="color:#ff79c6">paths</span>:
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">13</span>      - <span style="color:#ff79c6">path</span>: /
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">14</span>        <span style="color:#ff79c6">backend</span>:
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">15</span>          <span style="color:#ff79c6">serviceName</span>: nginx
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">16</span>          <span style="color:#ff79c6">servicePort</span>: <span style="color:#bd93f9">80</span>
</code></pre></div><h3 id="多host">多host</h3>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-yaml" data-lang="yaml"><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 1</span>cat &lt;&lt;EOF | kubectl create -f - 
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 2</span><span style="color:#ff79c6">apiVersion</span>: extensions/v1beta1
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 3</span><span style="color:#ff79c6">kind</span>: Ingress
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 4</span><span style="color:#ff79c6">metadata</span>:
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 5</span>  <span style="color:#ff79c6">name</span>: host
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 6</span><span style="color:#ff79c6">spec</span>:
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 7</span>  <span style="color:#ff79c6">rules</span>:
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 8</span>  - <span style="color:#ff79c6">host</span>: echo.vsxen.me
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 9</span>    <span style="color:#ff79c6">http</span>:
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">10</span>      <span style="color:#ff79c6">paths</span>:
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">11</span>      - <span style="color:#ff79c6">path</span>: /
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">12</span>        <span style="color:#ff79c6">backend</span>:
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">13</span>          <span style="color:#ff79c6">serviceName</span>: echo
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">14</span>          <span style="color:#ff79c6">servicePort</span>: <span style="color:#bd93f9">8080</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">15</span>  - <span style="color:#ff79c6">host</span>: nginx.vsxen.me
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">16</span>    <span style="color:#ff79c6">http</span>:
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">17</span>      <span style="color:#ff79c6">paths</span>:
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">18</span>      - <span style="color:#ff79c6">path</span>: /
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">19</span>        <span style="color:#ff79c6">backend</span>:
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">20</span>          <span style="color:#ff79c6">serviceName</span>: nginx
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">21</span>          <span style="color:#ff79c6">servicePort</span>: <span style="color:#bd93f9">80</span>    
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">22</span>EOF
</code></pre></div><h3 id="https">https</h3>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash"><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 1</span>openssl req -x509 -nodes -days <span style="color:#bd93f9">365</span> -newkey rsa:2048 -keyout tls.key -out tls.crt -subj <span style="color:#f1fa8c">&#34;/CN=foo.bar.com/O=foo.bar.com&#34;</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 2</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 3</span>kubectl  create secret tls tlskey --key<span style="color:#ff79c6">=</span>tls.key --cert<span style="color:#ff79c6">=</span>tls.crt
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 4</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 5</span>cat <span style="color:#f1fa8c">&lt;&lt;EOF | kubectl create -f - 
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 6</span><span style="color:#f1fa8c">apiVersion: extensions/v1beta1
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 7</span><span style="color:#f1fa8c">kind: Ingress
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 8</span><span style="color:#f1fa8c">metadata:
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 9</span><span style="color:#f1fa8c">  name: tls-fanout
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">10</span><span style="color:#f1fa8c">spec:
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">11</span><span style="color:#f1fa8c">  tls:
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">12</span><span style="color:#f1fa8c">  - hosts:
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">13</span><span style="color:#f1fa8c">    - foo.bar.com
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">14</span><span style="color:#f1fa8c">    secretName: tlskey
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">15</span><span style="color:#f1fa8c">  rules:
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">16</span><span style="color:#f1fa8c">  - host: foo.bar.com
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">17</span><span style="color:#f1fa8c">    http:
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">18</span><span style="color:#f1fa8c">      paths:
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">19</span><span style="color:#f1fa8c">      - path: /
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">20</span><span style="color:#f1fa8c">        backend:
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">21</span><span style="color:#f1fa8c">          serviceName: nginx
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">22</span><span style="color:#f1fa8c">          servicePort: 80
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">23</span><span style="color:#f1fa8c">EOF</span>
</code></pre></div><h3 id="前后端分离">前后端分离</h3>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-yaml" data-lang="yaml"><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 1</span><span style="color:#ff79c6">apiVersion</span>: extensions/v1beta1
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 2</span><span style="color:#ff79c6">kind</span>: Ingress
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 3</span><span style="color:#ff79c6">metadata</span>:
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 4</span>  <span style="color:#ff79c6">labels</span>:
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 5</span>    <span style="color:#ff79c6">app</span>: nginx
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 6</span>  <span style="color:#ff79c6">name</span>: demo
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 7</span><span style="color:#ff79c6">spec</span>:
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 8</span>  <span style="color:#ff79c6">rules</span>:
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 9</span>  - <span style="color:#ff79c6">host</span>: vsxen.me
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">10</span>    <span style="color:#ff79c6">http</span>:
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">11</span>      <span style="color:#ff79c6">paths</span>:
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">12</span>      - <span style="color:#ff79c6">backend</span>:
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">13</span>          <span style="color:#ff79c6">serviceName</span>: backend
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">14</span>          <span style="color:#ff79c6">servicePort</span>: <span style="color:#bd93f9">8080</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">15</span>        <span style="color:#ff79c6">path</span>: /api
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">16</span>      - <span style="color:#ff79c6">backend</span>:
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">17</span>          <span style="color:#ff79c6">serviceName</span>: front
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">18</span>          <span style="color:#ff79c6">servicePort</span>: <span style="color:#bd93f9">80</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">19</span>        <span style="color:#ff79c6">path</span>: /
</code></pre></div><h2 id="进阶">进阶</h2>
<p>作为整个集群的入口，Ng支持很多注解以及插件。比如用于灰度发布的注解<code>nginx.ingress.kubernetes.io/canary</code>，支持Jaeger的Opentracing插件（在configmap配置），同时Ng也支持自定义nginx.conf，但是需要用go template来写，默认使用的配置在这<a href="https://github.com/kubernetes/ingress-nginx/blob/master/rootfs/etc/nginx/template/nginx.tmpl">https://github.com/kubernetes/ingress-nginx/blob/master/rootfs/etc/nginx/template/nginx.tmpl</a></p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-yaml" data-lang="yaml"><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 1</span>        <span style="color:#ff79c6">volumeMounts</span>:
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 2</span>          - <span style="color:#ff79c6">mountPath</span>: /etc/nginx/template
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 3</span>            <span style="color:#ff79c6">name</span>: nginx-template-volume
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 4</span>            <span style="color:#ff79c6">readOnly</span>: <span style="color:#ff79c6">true</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 5</span>      <span style="color:#ff79c6">volumes</span>:
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 6</span>        - <span style="color:#ff79c6">name</span>: nginx-template-volume
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 7</span>          <span style="color:#ff79c6">configMap</span>:
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 8</span>            <span style="color:#ff79c6">name</span>: nginx-template
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 9</span>            <span style="color:#ff79c6">items</span>:
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">10</span>            - <span style="color:#ff79c6">key</span>: nginx.tmpl
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">11</span>              <span style="color:#ff79c6">path</span>: nginx.tmpl
</code></pre></div><p>所有的注解在这 <a href="https://kubernetes.github.io/ingress-nginx/user-guide/nginx-configuration/annotations/">https://kubernetes.github.io/ingress-nginx/user-guide/nginx-configuration/annotations/</a></p>
<p>所有的插件在这 <a href="https://kubernetes.github.io/ingress-nginx/user-guide/nginx-configuration/configmap/">https://kubernetes.github.io/ingress-nginx/user-guide/nginx-configuration/configmap/</a></p>
<p>对于不同的Ingress对象，Ng会生成不同的sever配置。下面是生成的对应的Nginx Server段，熟悉Nginx的人应该不陌生。</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-yaml" data-lang="yaml"><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 1</span>        <span style="color:#6272a4">## start server xxx.com</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 2</span>        server {
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 3</span>                server_name ssl.vsxen.me ;
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 4</span>                listen 80;
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 5</span>                set $proxy_upstream_name &#34;-&#34;;
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 6</span>                location / {
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 7</span>                        set $namespace      &#34;default&#34;;
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 8</span>                        set $ingress_name   &#34;nginx&#34;;
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 9</span>                        set $service_name   &#34;nginx&#34;;
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">10</span>                        set $service_port   &#34;80&#34;;
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">11</span>                        set $location_path  &#34;/&#34;;
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">12</span>                        rewrite_by_lua_block {
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">13</span>                                balancer.rewrite()
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">14</span>                        }
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">15</span>                        header_filter_by_lua_block {
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">16</span>                        }
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">17</span>                        body_filter_by_lua_block {
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">18</span>                        }
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">19</span>                        log_by_lua_block {
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">20</span>                                balancer.log()
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">21</span>                                monitor.call()
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">22</span>                        }
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">23</span>                        port_in_redirect off;
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">24</span>                        set $proxy_upstream_name    &#34;quanke-test-gateway-serv-8092&#34;;
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">25</span>                        set $proxy_host             $proxy_upstream_name;
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">26</span>                        client_max_body_size                    20m;
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">27</span>                        proxy_set_header Host                   $best_http_host;
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">28</span>                        <span style="color:#6272a4"># Pass the extracted client certificate to the backend</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">29</span>                        <span style="color:#6272a4"># Allow websocket connections</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">30</span>                        proxy_set_header                        Upgrade           $http_upgrade;
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">31</span>                        proxy_set_header                        Connection        $connection_upgrade;
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">32</span>                        proxy_set_header X-Request-ID           $req_id;
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">33</span>                        proxy_set_header X-Real-IP              $the_real_ip;
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">34</span>                        proxy_set_header X-Forwarded-For        $the_real_ip;
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">35</span>                        proxy_set_header X-Forwarded-Host       $best_http_host;
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">36</span>                        proxy_set_header X-Forwarded-Port       $pass_port;
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">37</span>                        proxy_set_header X-Forwarded-Proto      $pass_access_scheme;
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">38</span>                        proxy_set_header X-Original-URI         $request_uri;
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">39</span>                        proxy_set_header X-Scheme               $pass_access_scheme;
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">40</span>                        <span style="color:#6272a4"># Pass the original X-Forwarded-For</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">41</span>                        proxy_set_header X-Original-Forwarded-For $http_x_forwarded_for;
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">42</span>                        <span style="color:#6272a4"># mitigate HTTPoxy Vulnerability</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">43</span>                        <span style="color:#6272a4"># https://www.nginx.com/blog/mitigating-the-httpoxy-vulnerability-with-nginx/</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">44</span>                        proxy_set_header Proxy                  &#34;&#34;;
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">45</span>                        <span style="color:#6272a4"># Custom headers to proxied server</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">46</span>                        proxy_connect_timeout                   5s;
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">47</span>                        proxy_send_timeout                      60s;
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">48</span>                        proxy_read_timeout                      60s;
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">49</span>                        proxy_buffering                         off;
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">50</span>                        proxy_buffer_size                       4k;
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">51</span>                        proxy_buffers                           4 4k;
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">52</span>                        proxy_request_buffering                 on;
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">53</span>                        proxy_http_version                      1.1;
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">54</span>                        proxy_cookie_domain                     off;
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">55</span>                        proxy_cookie_path                       off;
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">56</span>                        <span style="color:#6272a4"># In case of errors try the next upstream server before returning an error</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">57</span>                        proxy_next_upstream                     error timeout;
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">58</span>                        proxy_next_upstream_tries               3;
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">59</span>                        proxy_pass http://upstream_balancer;
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">60</span>                        proxy_redirect                          off;
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">61</span>                }
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">62</span>        }
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">63</span>        <span style="color:#6272a4">## end server xxx.com</span>
</code></pre></div><h2 id="access-log">Access Log</h2>
<p>默认的日志输出如下</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash"><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 1</span>log_format upstreaminfo
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 2</span>    <span style="color:#f1fa8c">&#39;{{ if $cfg.useProxyProtocol }}$proxy_protocol_addr{{ else }}$remote_addr{{ end }} - &#39;</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 3</span>    <span style="color:#f1fa8c">&#39;[$the_real_ip] - $remote_user [$time_local] &#34;$request&#34; &#39;</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 4</span>    <span style="color:#f1fa8c">&#39;$status $body_bytes_sent &#34;$http_referer&#34; &#34;$http_user_agent&#34; &#39;</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 5</span>    <span style="color:#f1fa8c">&#39;$request_length $request_time [$proxy_upstream_name] $upstream_addr &#39;</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 6</span>    <span style="color:#f1fa8c">&#39;$upstream_response_length $upstream_response_time $upstream_status $req_id&#39;</span>;
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 7</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 8</span>  log-format-upstream: <span style="color:#f1fa8c">&#39;{&#34;proxy_protocol_addr&#34;: &#34;$proxy_protocol_addr&#34;,&#34;remote_addr&#34;:
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 9</span><span style="color:#f1fa8c">    &#34;$remote_addr&#34;, &#34;proxy_add_x_forwarded_for&#34;: &#34;$proxy_add_x_forwarded_for&#34;, &#34;remote_user&#34;:
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">10</span><span style="color:#f1fa8c">    &#34;$remote_user&#34;, &#34;time_local&#34;: &#34;$time_local&#34;, &#34;request&#34; : &#34;$request&#34;, &#34;status&#34;:
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">11</span><span style="color:#f1fa8c">    &#34;$status&#34;, &#34;body_bytes_sent&#34;: &#34;$body_bytes_sent&#34;, &#34;http_referer&#34;:  &#34;$http_referer&#34;,
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">12</span><span style="color:#f1fa8c">    &#34;http_user_agent&#34;: &#34;$http_user_agent&#34;, &#34;request_length&#34; : &#34;$request_length&#34;, &#34;request_time&#34;
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">13</span><span style="color:#f1fa8c">    : &#34;$request_time&#34;, &#34;proxy_upstream_name&#34;: &#34;$proxy_upstream_name&#34;, &#34;upstream_addr&#34;:
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">14</span><span style="color:#f1fa8c">    &#34;$upstream_addr&#34;,  &#34;upstream_response_length&#34;: &#34;$upstream_response_length&#34;, &#34;upstream_response_time&#34;:
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">15</span><span style="color:#f1fa8c">    &#34;$upstream_response_time&#34;, &#34;upstream_status&#34;: &#34;$upstream_status&#34;, &#34;req_id&#34;:&#34;$req_id&#34;}&#39;</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">16</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">17</span>203.110.179.243 - <span style="color:#ff79c6">[</span>203.110.179.243<span style="color:#ff79c6">]</span> - - <span style="color:#ff79c6">[</span>11/Jan/2019:14:44:55 +0800<span style="color:#ff79c6">]</span> <span style="color:#f1fa8c">&#34;GET /favicon.ico HTTP/1.1&#34;</span> <span style="color:#bd93f9">404</span> <span style="color:#bd93f9">196</span> <span style="color:#f1fa8c">&#34;http://nginx.cf86fc3209f4e483493e504197bfdd22f.cn-hangzhou.alicontainer.com/&#34;</span> <span style="color:#f1fa8c">&#34;Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/71.0.3578.98 Safari/537.36&#34;</span> <span style="color:#bd93f9">458</span> 0.001 <span style="color:#ff79c6">[</span>default-nginx-80<span style="color:#ff79c6">]</span> 172.16.1.173:80 <span style="color:#bd93f9">555</span> 0.000 <span style="color:#bd93f9">404</span> 7b02134be96609d93aa4318a826a40b3    
</code></pre></div><p>获取客户端Real IP，对于Service Spec来说有一个externalTrafficPolicy字段，效果如下所示</p>
<pre><code>  externalTrafficPolicy: Cluster
10.244.0.1 - [10.244.0.1] - - [11/Apr/2019:13:54:51 +0000] &quot;GET / HTTP/2.0&quot; 200 392 &quot;-&quot; &quot;Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/73.0.3683.86 Safari/537.36&quot; 431 0.001 [default-nginx-80] 10.244.0.144:80 612 0.000 200 42ce047ab4b6909266aeca53af3e6b08
  externalTrafficPolicy: Local
23.10.19.23 - [23.10.19.23] - - [11/Jan/2019:14:44:55 +0800] &quot;GET /favicon.ico HTTP/1.1&quot; 404 196 &quot;http://nginx.cf86fc3209f4e483493e504197bfdd22f.cn-hangzhou.alicontainer.com/&quot; &quot;Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/71.0.3578.98 Safari/537.36&quot; 458 0.001 [default-nginx-80] 172.16.1.173:80 555 0.000 404 7b02134be96609d93aa4318a826a40b3    
</code></pre><div class="highlight"><pre style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-xml" data-lang="xml"><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 1</span>    <span style="color:#ff79c6">&lt;source&gt;</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 2</span>      @id fluentd-containers.log
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 3</span>      @type tail
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 4</span>      path /var/log/containers/*.log
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 5</span>      pos_file /var/log/es-containers.log.pos
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 6</span>      tag raw.kubernetes.*
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 7</span>      read_from_head true
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 8</span>      <span style="color:#ff79c6">&lt;parse&gt;</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 9</span>        @type multi_format
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">10</span>        <span style="color:#ff79c6">&lt;pattern&gt;</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">11</span>          format json
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">12</span>          time_key time
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">13</span>          time_format %Y-%m-%dT%H:%M:%S.%NZ
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">14</span>        <span style="color:#ff79c6">&lt;/pattern&gt;</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">15</span>        <span style="color:#ff79c6">&lt;pattern&gt;</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">16</span>          format /^(?<span style="color:#ff79c6">&lt;time&gt;</span>.+) (?<span style="color:#ff79c6">&lt;stream&gt;</span>stdout|stderr) [^ ]* (?<span style="color:#ff79c6">&lt;log&gt;</span>.*)$/
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">17</span>          time_format %Y-%m-%dT%H:%M:%S.%N%:z
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">18</span>        <span style="color:#ff79c6">&lt;/pattern&gt;</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">19</span>      <span style="color:#ff79c6">&lt;/parse&gt;</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">20</span>    <span style="color:#ff79c6">&lt;/source&gt;</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">21</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">22</span>    # Detect exceptions in the log output and forward them as one log entry.
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">23</span>    <span style="color:#ff79c6">&lt;match</span> raw.kubernetes.**<span style="color:#ff79c6">&gt;</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">24</span>      @id raw.kubernetes
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">25</span>      @type detect_exceptions
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">26</span>      remove_tag_prefix raw
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">27</span>      message log
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">28</span>      stream stream
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">29</span>      multiline_flush_interval 5
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">30</span>      max_bytes 500000
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">31</span>      max_lines 1000
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">32</span>    <span style="color:#ff79c6">&lt;/match&gt;</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">33</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">34</span>    # Concatenate multi-line logs
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">35</span>    <span style="color:#ff79c6">&lt;filter</span> **<span style="color:#ff79c6">&gt;</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">36</span>      @id filter_concat
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">37</span>      @type concat
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">38</span>      key message
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">39</span>      multiline_end_regexp /\n$/
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">40</span>      separator &#34;&#34;
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">41</span>    <span style="color:#ff79c6">&lt;/filter&gt;</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">42</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">43</span>    # Enriches records with Kubernetes metadata
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">44</span>    <span style="color:#ff79c6">&lt;filter</span> kubernetes.**<span style="color:#ff79c6">&gt;</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">45</span>      @id filter_kubernetes_metadata
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">46</span>      @type kubernetes_metadata
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">47</span>    <span style="color:#ff79c6">&lt;/filter&gt;</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">48</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">49</span>    # Fixes json fields in Elasticsearch
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">50</span>    <span style="color:#ff79c6">&lt;filter</span> kubernetes.**<span style="color:#ff79c6">&gt;</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">51</span>      @id filter_parser
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">52</span>      @type parser
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">53</span>      key_name log
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">54</span>      reserve_data true
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">55</span>      remove_key_name_field true
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">56</span>      <span style="color:#ff79c6">&lt;parse&gt;</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">57</span>        @type multi_format
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">58</span>        <span style="color:#ff79c6">&lt;pattern&gt;</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">59</span>          format json
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">60</span>        <span style="color:#ff79c6">&lt;/pattern&gt;</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">61</span>        <span style="color:#ff79c6">&lt;pattern&gt;</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">62</span>          format none
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">63</span>        <span style="color:#ff79c6">&lt;/pattern&gt;</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">64</span>      <span style="color:#ff79c6">&lt;/parse&gt;</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">65</span>    <span style="color:#ff79c6">&lt;/filter&gt;</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">66</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">67</span>    <span style="color:#ff79c6">&lt;match</span> **<span style="color:#ff79c6">&gt;</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">68</span>      @id elasticsearch
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">69</span>      @type elasticsearch
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">70</span>      @log_level info
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">71</span>      type_name _doc
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">72</span>      include_tag_key true
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">73</span>      host 1.1.1.1
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">74</span>      port 9200
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">75</span>      logstash_format true
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">76</span>      logstash_prefix audit
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">77</span>      <span style="color:#ff79c6">&lt;buffer&gt;</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">78</span>        @type file
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">79</span>        path /var/log/fluentd-buffers/kubernetes.system.buffer
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">80</span>        flush_mode interval
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">81</span>        retry_type exponential_backoff
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">82</span>        flush_thread_count 2
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">83</span>        flush_interval 5s
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">84</span>        retry_forever
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">85</span>        retry_max_interval 30
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">86</span>        chunk_limit_size 2M
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">87</span>        queue_limit_length 8
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">88</span>        overflow_action block
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">89</span>      <span style="color:#ff79c6">&lt;/buffer&gt;</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">90</span>    <span style="color:#ff79c6">&lt;/match&gt;</span>
</code></pre></div><h2 id="ref">Ref</h2>
<p>kubedex 出品的对比表格</p>
<p><a href="https://docs.google.com/spreadsheets/d/16bxRgpO1H_Bn-5xVZ1WrR_I-0A-GOI6egmhvqqLMOmg/edit#gid=1612037324">https://docs.google.com/spreadsheets/d/16bxRgpO1H_Bn-5xVZ1WrR_I-0A-GOI6egmhvqqLMOmg/edit#gid=1612037324</a></p>

    </div>
  </article>

  
  






  <div id="footer-post-container">
  <div id="footer-post">

    <div id="nav-footer" style="display: none">
      <ul>
         
          <li><a href="/">Home</a></li>
         
          <li><a href="/posts">Writings</a></li>
         
          <li><a href="/tags">Tags</a></li>
         
          <li><a href="/about">About</a></li>
        
      </ul>
    </div>

    
    <div id="toc-footer" style="display: none">
      <nav id="TableOfContents">
  <ul>
    <li><a href="#install">Install</a></li>
    <li><a href="#配置">配置</a>
      <ul>
        <li><a href="#最简单的">最简单的</a></li>
        <li><a href="#多host">多host</a></li>
        <li><a href="#https">https</a></li>
        <li><a href="#前后端分离">前后端分离</a></li>
      </ul>
    </li>
    <li><a href="#进阶">进阶</a></li>
    <li><a href="#access-log">Access Log</a></li>
    <li><a href="#ref">Ref</a></li>
  </ul>
</nav>
    </div>
    

    <div id="share-footer" style="display: none">
      
      <ul>
  
  
    
  
  
  <li>
    <a class="icon" href="http://www.facebook.com/sharer.php?u=https%3a%2f%2fexample.com%2fposts%2fk8s-ingress-useage%2f" aria-label="Facebook">
      <i class="fab fa-facebook fa-lg" aria-hidden="true"></i>
    </a>
  </li>
  <li>
    <a class="icon" href="https://twitter.com/share?url=https%3a%2f%2fexample.com%2fposts%2fk8s-ingress-useage%2f&text=k8s%20%e4%b8%83%e5%b1%82%e8%ae%bf%e9%97%ae%e5%85%a5%e5%8f%a3%20Ingress" aria-label="Twitter">
      <i class="fab fa-twitter fa-lg" aria-hidden="true"></i>
    </a>
  </li>
  <li>
    <a class="icon" href="http://www.linkedin.com/shareArticle?url=https%3a%2f%2fexample.com%2fposts%2fk8s-ingress-useage%2f&title=k8s%20%e4%b8%83%e5%b1%82%e8%ae%bf%e9%97%ae%e5%85%a5%e5%8f%a3%20Ingress" aria-label="Linkedin">
      <i class="fab fa-linkedin fa-lg" aria-hidden="true"></i>
    </a>
  </li>
  <li>
    <a class="icon" href="https://pinterest.com/pin/create/bookmarklet/?url=https%3a%2f%2fexample.com%2fposts%2fk8s-ingress-useage%2f&is_video=false&description=k8s%20%e4%b8%83%e5%b1%82%e8%ae%bf%e9%97%ae%e5%85%a5%e5%8f%a3%20Ingress" aria-label="Pinterest">
      <i class="fab fa-pinterest fa-lg" aria-hidden="true"></i>
    </a>
  </li>
  <li>
    <a class="icon" href="mailto:?subject=k8s%20%e4%b8%83%e5%b1%82%e8%ae%bf%e9%97%ae%e5%85%a5%e5%8f%a3%20Ingress&body=Check out this article: https%3a%2f%2fexample.com%2fposts%2fk8s-ingress-useage%2f" aria-label="Email">
      <i class="fas fa-envelope fa-lg" aria-hidden="true"></i>
    </a>
  </li>
  <li>
    <a class="icon" href="https://getpocket.com/save?url=https%3a%2f%2fexample.com%2fposts%2fk8s-ingress-useage%2f&title=k8s%20%e4%b8%83%e5%b1%82%e8%ae%bf%e9%97%ae%e5%85%a5%e5%8f%a3%20Ingress" aria-label="Pocket">
      <i class="fab fa-get-pocket fa-lg" aria-hidden="true"></i>
    </a>
  </li>
  <li>
    <a class="icon" href="http://reddit.com/submit?url=https%3a%2f%2fexample.com%2fposts%2fk8s-ingress-useage%2f&title=k8s%20%e4%b8%83%e5%b1%82%e8%ae%bf%e9%97%ae%e5%85%a5%e5%8f%a3%20Ingress" aria-label="reddit">
      <i class="fab fa-reddit fa-lg" aria-hidden="true"></i>
    </a>
  </li>
  <li>
    <a class="icon" href="http://www.tumblr.com/share/link?url=https%3a%2f%2fexample.com%2fposts%2fk8s-ingress-useage%2f&name=k8s%20%e4%b8%83%e5%b1%82%e8%ae%bf%e9%97%ae%e5%85%a5%e5%8f%a3%20Ingress&description=k8s%e5%88%9d%e6%9c%9f%e7%9a%84%e6%97%b6%e5%80%99%ef%bc%8c%e5%8f%aa%e6%9c%89Service%e4%bd%9c%e4%b8%ba%e5%9b%9b%e5%b1%82%e8%b4%9f%e8%bd%bd%e5%9d%87%e8%a1%a1%ef%bc%8c%e5%90%8e%e6%9d%a5%e6%89%8d%e6%8e%a8%e5%87%ba%e4%ba%86%e4%b8%93%e9%97%a8%e7%94%a8%e4%bd%9c%e4%b8%83%e5%b1%82%e7%9a%84%e8%b4%9f%e8%bd%bd%e5%9d%87%e8%a1%a1%26ndash%3bIngress%e3%80%82%e7%ac%ac%e4%b8%80%e6%89%b9%e5%ae%9e%e7%8e%b0Ingress%20Controller%e7%9a%84%e5%b0%b1%e6%98%aftraefik%e4%bb%a5%e5%8f%8aNginx%20Ingress%ef%bc%8c%e5%90%8e%e6%9d%a5%e9%9a%8f%e7%9d%80Envory%e7%9a%84%e5%87%ba%e7%8e%b0%ef%bc%8c%e4%b9%9f%e9%80%90%e6%b8%90%e6%b6%8c%e7%8e%b0%e5%87%ba%e4%ba%86%e8%b6%8a%e6%9d%a5%e8%b6%8a%e5%a4%9a%e7%9a%84Ingress%20Controller%e5%ae%9e%e7%8e%b0%ef%bc%8c%e6%af%94%e5%a6%82%ef%bc%9a%0a%20https%3a%2f%2fgithub.com%2fheptio%2fcontour%20https%3a%2f%2fgithub.com%2fdatawire%2fambassador%20https%3a%2f%2fgithub.com%2fistio%2fistio%2f%20%20%e4%bd%86%e6%98%af%e8%bf%99%e4%ba%9b%e5%ae%9e%e7%8e%b0%e7%9a%84%e5%8e%9f%e7%90%86%e8%af%b4%e5%88%b0%e5%ba%95%e5%b0%b1%e6%98%afwatch%e5%90%8e%e7%ab%af%e7%9a%84Service%ef%bc%8c%e7%84%b6%e5%90%8e%e5%88%9b%e5%bb%ba%e5%af%b9%e4%ba%8e%e7%9a%84%e8%ae%bf%e9%97%ae%e8%a7%84%e5%88%99%e3%80%82%0aInstall%20%e4%bb%a5Nginx%20Ingress%e4%b8%ba%e4%be%8b%ef%bc%8c%e7%94%b1Go%ef%bc%8cLua%e5%92%8cC%e4%b8%89%e7%a7%8d%e8%af%ad%e8%a8%80%e7%bb%84%e6%88%90%ef%bc%8cGo%e8%b4%9f%e8%b4%a3%e4%b8%8ek8s%20API%e4%ba%a4%e4%ba%92%ef%bc%8c%e4%b8%8b%e9%9d%a2%e7%ae%80%e5%8d%95%e4%bb%8b%e7%bb%8d%e4%b8%80%e4%ba%9b%e5%ae%89%e8%a3%85%e8%bf%87%e7%a8%8b%e3%80%82%0a1%23%e9%a6%96%e5%85%88%e5%ae%89%e8%a3%85%e6%8e%a7%e5%88%b6%e5%99%a8%ef%bc%8c%202kubectl%20apply%20-f%20https%3a%2f%2fraw.githubusercontent.com%2fkubernetes%2fingress-nginx%2fmaster%2fdeploy%2fmandatory.yaml%203%23%e7%84%b6%e5%90%8e%e5%88%9b%e5%bb%baService%204kubectl%20apply%20-f%20https%3a%2f%2fraw.githubusercontent.com%2fkubernetes%2fingress-nginx%2fmaster%2fdeploy%2fprovider%2fbaremetal%2fservice-nodeport.yaml%20%e4%bb%a5%e4%b8%8a%e6%98%af%e5%b1%9e%e4%ba%8eBate-metal%e7%9a%84%e9%85%8d%e7%bd%ae%ef%bc%8c%e5%a6%82%e6%9e%9c%e4%bd%a0%e6%98%af%e5%9c%a8Public%20CLoud%e5%8f%af%e4%bb%a5%e6%9b%bf%e6%8d%a2%e4%b8%baLoadBalancer%e3%80%82%e4%bb%94%e7%bb%86%e8%a7%82%e5%af%9f%e4%b8%80%e4%b8%8b%e7%ac%ac%e4%b8%80%e4%b8%aayaml%e6%96%87%e4%bb%b6%ef%bc%8c%e5%8f%af%e4%bb%a5%e5%8f%91%e7%8e%b0%e6%9c%89%e4%ba%9b%e7%89%b9%e6%ae%8a%e7%9a%84%e5%9c%b0%e6%96%b9%ef%bc%8c%e5%a6%82%e4%b8%8b%e6%89%80%e7%a4%ba%ef%bc%8c%e6%9c%89%e4%b8%80%e4%b8%aa%e7%89%b9%e6%ae%8a%e7%9a%84annotations%ef%bc%8c%e7%9c%8b%e6%9d%a5%e5%92%8cAPIServer%e7%b1%bb%e4%bc%bc%ef%bc%8c%e6%94%af%e6%8c%81%e5%a4%9a%e5%89%af%e6%9c%ac%e9%ab%98%e5%8f%af%e7%94%a8%e3%80%82%0aI0411%2009%3a11%3a06.783582%207%20leaderelection.go%3a227%5d%20successfully%20acquired%20lease%20ingress-nginx%2fingress-controller-leader-nginx%0a1kubectl%20-n%20ingress-nginx%20get%20cm%20ingress-controller-leader-nginx%20-oyaml%202apiVersion%3a%20v1%203kind%3a%20ConfigMap%204metadata%3a%205%20annotations%3a%206%20control-plane.alpha.kubernetes.io%2fleader%3a%20%26%2339%3b%7b%26%2334%3bholderIdentity%26%2334%3b%3a%26%2334%3bnginx-ingress-controller-85f9f75759-4wb8k%26%2334%3b%2c%26%2334%3bleaseDurationSeconds%26%2334%3b%3a30%2c%26%2334%3bacquireTime%26%2334%3b%3a%26%2334%3b2019-04-11T09%3a11%3a06Z%26%2334%3b%2c%26%2334%3brenewTime%26%2334%3b%3a%26%2334%3b2019-04-11T13%3a12%3a56Z%26%2334%3b%2c%26%2334%3bleaderTransitions%26%2334%3b%3a0%7d%26%2339%3b%207%20creationTimestamp%3a%20%26%2334%3b2019-04-11T09%3a11%3a06Z%26%2334%3b%208%20name%3a%20ingress-controller-leader-nginx%209%20namespace%3a%20ingress-nginx%2010%20resourceVersion%3a%20%26%2334%3b28998%26%2334%3b%2011%20selfLink%3a%20%2fapi%2fv1%2fnamespaces%2fingress-nginx%2fconfigmaps%2fingress-controller-leader-nginx%2012%20uid%3a%20bd25d320-5c39-11e9-af65-00163e132347%20%e5%9b%a0%e4%b8%baNginx%e5%8e%9f%e7%94%9f%e6%94%af%e6%8c%81%e5%9b%9b%e5%b1%82%e8%b4%9f%e8%bd%bd%e5%9d%87%e8%a1%a1%ef%bc%8c%e6%89%80%e6%9c%89Nginx%20Ingress%e4%b9%9f%e6%98%af%e6%94%af%e6%8c%81%e5%9b%9b%e5%b1%82%e7%9a%84%e3%80%82" aria-label="Tumblr">
      <i class="fab fa-tumblr fa-lg" aria-hidden="true"></i>
    </a>
  </li>
  <li>
    <a class="icon" href="https://news.ycombinator.com/submitlink?u=https%3a%2f%2fexample.com%2fposts%2fk8s-ingress-useage%2f&t=k8s%20%e4%b8%83%e5%b1%82%e8%ae%bf%e9%97%ae%e5%85%a5%e5%8f%a3%20Ingress" aria-label="Hacker News">
      <i class="fab fa-hacker-news fa-lg" aria-hidden="true"></i>
    </a>
  </li>
</ul>

    </div>

    <div id="actions-footer">
      
        <a id="menu-toggle" class="icon" href="#" onclick="$('#nav-footer').toggle();return false;" aria-label="Menu">
          <i class="fas fa-bars fa-lg" aria-hidden="true"></i> Menu</a>
        
        <a id="toc-toggle" class="icon" href="#" onclick="$('#toc-footer').toggle();return false;" aria-label="TOC">
          <i class="fas fa-list fa-lg" aria-hidden="true"></i> TOC</a>
        
        <a id="share-toggle" class="icon" href="#" onclick="$('#share-footer').toggle();return false;" aria-label="Share">
          <i class="fas fa-share-alt fa-lg" aria-hidden="true"></i> share</a>
        <a id="top" style="display:none" class="icon" href="#" onclick="$('html, body').animate({ scrollTop: 0 }, 'fast');" aria-label="Top of Page">
          <i class="fas fa-chevron-up fa-lg" aria-hidden="true"></i> Top</a>
    </div>

  </div>
</div>


  <footer id="footer">
  <div class="footer-left">
    Copyright  &copy; 2025  You 
  </div>
  <div class="footer-right">
    <nav>
      <ul>
         
        <li><a href="/">Home</a></li>
         
        <li><a href="/posts">Writings</a></li>
         
        <li><a href="/tags">Tags</a></li>
         
        <li><a href="/about">About</a></li>
        
      </ul>
    </nav>
  </div>
</footer>


  </div>
</body>

<link rel="stylesheet" href=/lib/font-awesome/css/all.min.css>
<script src=/lib/jquery/jquery.min.js></script>
<script src=/js/main.js></script>

<script src=/js/code-copy.js></script>




</html>
