<!DOCTYPE html>
<html lang="zh-cn" >
<head>
  <meta charset="utf-8"/>
  <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>

  
  <meta name="author"
        content="vsxen"/>

  
  <meta name="description" content="下载 初始化 terraform 扩展主要靠的就是provider，所以在使用之前需要准备好或者下载对应的provider。至于你需要什么provider，需要在main.tf指定，如下所示。 如果可以联网的话，貌似会从fa"/>
  

  
  
  <meta name="keywords" content="blog, k8s, devops"/>
  

  
  <link rel="canonical" href="https://vsxen.github.io/2018/09/17/terraform/"/>

  

  <title>terraform provider Kubernetes 入门 &middot; Code Life</title>

  <link rel="shortcut icon" href="https://vsxen.github.io/images/favicon.ico"/>
  <link rel="stylesheet" href="https://vsxen.github.io/css/animate.min.css"/>
  <link rel="stylesheet" href="https://vsxen.github.io/css/remixicon.css"/>
  <link rel="stylesheet" href="https://vsxen.github.io/css/zozo.css"/>
  <link rel="stylesheet" href="https://vsxen.github.io/css/highlight.css"/>

  
  

  <script>
    (function(d) {
      var config = {
        kitId: 'kfn1kkp',
        scriptTimeout: 3000,
        async: true
      },
      h=d.documentElement,t=setTimeout(function(){h.className=h.className.replace(/\bwf-loading\b/g,"")+" wf-inactive";},config.scriptTimeout),tk=d.createElement("script"),f=false,s=d.getElementsByTagName("script")[0],a;h.className+=" wf-loading";tk.src='https://use.typekit.net/'+config.kitId+'.js';tk.async=true;tk.onload=tk.onreadystatechange=function(){a=this.readyState;if(f||a&&a!="complete"&&a!="loaded")return;f=true;clearTimeout(t);try{Typekit.load(config)}catch(e){}};s.parentNode.insertBefore(tk,s)
    })(document);
  </script>
</head>

<body>
<div class="main animated">
  <div class="nav_container animated fadeInDown">
  <div class="site_nav" id="site_nav">
    <ul>
      
      <li>
        <a href="/">首页</a>
      </li>
      
      <li>
        <a href="/posts/">归档</a>
      </li>
      
      <li>
        <a href="/tags/">标签</a>
      </li>
      
      <li>
        <a href="/about/">关于</a>
      </li>
      
    </ul>
  </div>
  <div class="menu_icon">
    <a id="menu_icon"><i class="remixicon-links-line"></i></a>
  </div>
</div>

  <div class="header animated fadeInDown">
  <div class="site_title_container">
    <div class="site_title">
      <h1>
        <a href="https://vsxen.github.io">
          <span>Code Life</span>
          <img src="https://vsxen.github.io/images/logo.svg"/>
        </a>
      </h1>
    </div>
    <div class="description">
      <p class="sub_title">Life is too bug</p>
      <div class="my_socials">
        
        
        <a href="%20" title="facebook" target="_blank"><i class="remixicon-facebook-fill"></i></a>
        
        
        
        <a href="%20" title="github" target="_blank"><i class="remixicon-github-fill"></i></a>
        
        
        
        <a href="%20" title="instagram" target="_blank"><i class="remixicon-instagram-fill"></i></a>
        
        
        
        <a href="%20" title="twitter" target="_blank"><i class="remixicon-twitter-fill"></i></a>
        
        
        
        <a href="%20" title="weibo" target="_blank"><i class="remixicon-weibo-fill"></i></a>
        
        
        <a href="https://vsxen.github.io/index.xml" type="application/rss+xml" title="rss" target="_blank"><i class="remixicon-rss-fill"></i></a>
      </div>
    </div>
  </div>
</div>

  <div class="content">
    <div class="post_page">
      <div class="post animated fadeInDown">
        <div class="post_title post_detail_title">
          <h2><a href='/2018/09/17/terraform/'>terraform provider Kubernetes 入门</a></h2>
          <span class="date">2018.09.17</span>
        </div>
        <div class="post_content markdown">

<p>下载</p>

<h3 id="初始化">初始化</h3>

<p>terraform 扩展主要靠的就是provider，所以在使用之前需要准备好或者下载对应的provider。至于你需要什么provider，需要在<code>main.tf</code>指定，如下所示。</p>

<p>如果可以联网的话，貌似会从fastly的CDN上下载，默认放在<code>~/.terraform/plugins</code>目录，离线安装或者自己build的话也可以放在对应的目录即可。</p>

<p>terraform默认会读取kubeconfig的默认配置，有点绕口，也可以自己配置对应的证书或者basic auth，这一点可以去看官方文档，我配置的就是读取默认配置。然后就就可以初始化去下载k8s的provider了。</p>

<pre><code class="language-bash">cat main.tf
provider &quot;kubernetes&quot; {}
# 初始化
terraform init

Initializing the backend...

Initializing provider plugins...
- Checking for available provider plugins...
- Downloading plugin for provider &quot;kubernetes&quot; (hashicorp/kubernetes) 1.9.0...

The following providers do not have any version constraints in configuration,
so the latest version was installed.

To prevent automatic upgrades to new major versions that may contain breaking
changes, it is recommended to add version = &quot;...&quot; constraints to the
corresponding provider blocks in configuration, with the constraint strings
suggested below.

* provider.kubernetes: version = &quot;~&gt; 1.9&quot;

Terraform has been successfully initialized!

You may now begin working with Terraform. Try running &quot;terraform plan&quot; to see
any changes that are required for your infrastructure. All Terraform commands
should now work.

If you ever set or change modules or backend configuration for Terraform,
rerun this command to reinitialize your working directory. If you forget, other
commands will detect it and remind you to do so if necessary.
# 默认provider的下载路径
ls ~/.terraform/plugins/linux_amd64/
lock.json  terraform-provider-kubernetes_v1.9.0_x4
</code></pre>

<h3 id="发布">发布</h3>

<p>terraform默认读取的是当前文件目录所有的.tf的文件，首先我们创建一个nginx的pod，如下所示，定义一些必要的参数，然后就可以发布到k8s上面了。</p>

<pre><code class="language-bash">cat nginx.tf
resource &quot;kubernetes_pod&quot; &quot;nginx&quot; {
  metadata {
    name = &quot;nginx-example&quot;
    labels = {
      App = &quot;nginx&quot;
    }
  }
  spec {
    container {
      image = &quot;nginx:1.1&quot;
      name  = &quot;example&quot;

      port {
        container_port = 80
      }
    }
  }
}

# 发布
terraform apply

An execution plan has been generated and is shown below.
Resource actions are indicated with the following symbols:
  + create

Terraform will perform the following actions:
# 省略
Plan: 1 to add, 0 to change, 0 to destroy.

Do you want to perform these actions?
  Terraform will perform the actions described above.
  Only 'yes' will be accepted to approve.

  Enter a value: # 这里会二次确认一下
  
kubernetes_pod.nginx: Creating...
kubernetes_pod.nginx: Creation complete after 4s [id=default/nginx-example]

Apply complete! Resources: 1 added, 0 changed, 0 destroyed.  

# 验证
$ kubectl get po
NAME            READY   STATUS    RESTARTS   AGE
nginx-example   1/1     Running   0          18h
</code></pre>

<h3 id="更新">更新</h3>

<p>接着我们来试一下更新镜像，也就是发布流程，修改<code>nginx.tf</code>的镜像名字，然后运行<code>terraform plan</code>就能看到这一次涉及到的更改，如下所示：</p>

<pre><code class="language-bash">terraform plan
Refreshing Terraform state in-memory prior to plan...
The refreshed state will be used to calculate this plan, but will not be
persisted to local or remote state storage.

kubernetes_pod.nginx: Refreshing state... [id=default/nginx-example]

------------------------------------------------------------------------

An execution plan has been generated and is shown below.
Resource actions are indicated with the following symbols:
  ~ update in-place

Terraform will perform the following actions:

  # kubernetes_pod.nginx will be updated in-place
# 略
          ~ container {
                args                     = []
                command                  = []
              ~ image                    = &quot;nginx:alpine&quot; -&gt; &quot;nginx:1.1&quot;
                image_pull_policy        = &quot;IfNotPresent&quot;
                name                     = &quot;example&quot;
                stdin                    = false
                stdin_once               = false
                termination_message_path = &quot;/dev/termination-log&quot;
                tty                      = false

                port {
                    container_port = 80
                    host_port      = 0
                    protocol       = &quot;TCP&quot;
                }

                resources {
                }
            }
        }
    }

Plan: 0 to add, 1 to change, 0 to destroy.

------------------------------------------------------------------------

Note: You didn't specify an &quot;-out&quot; parameter to save this plan, so Terraform
can't guarantee that exactly these actions will be performed if
&quot;terraform apply&quot; is subsequently run.

</code></pre>

<p>和kubectl的区别？kubectl提供了diff 的子命令，可以对比与正在运行的pod的区别，如下所示：</p>

<pre><code class="language-bash">kubectl diff -f nginxpod.yaml
diff -u -N /tmp/LIVE-346592871/v1.Pod.default.nginx-example /tmp/MERGED-289406106/v1.Pod.default.nginx-example
--- /tmp/LIVE-346592871/v1.Pod.default.nginx-example    2019-09-07 18:48:06.963341550 +0800
+++ /tmp/MERGED-289406106/v1.Pod.default.nginx-example  2019-09-07 18:48:06.967341550 +0800
@@ -12,7 +12,7 @@
 spec:
   automountServiceAccountToken: false
   containers:
-  - image: nginx:alpine
+  - image: nginx:1.1
     imagePullPolicy: IfNotPresent
     name: example
     ports:
exit status 1

</code></pre>

<h3 id="其他">其他？</h3>

<p>本文也只是对terraform的简单使用，最多算一个入门而已，至于terraform的精华，可能还未涉及到。</p>

<p>思考</p>

<ul>
<li>多环境支持？</li>
<li>多应用维护？</li>
</ul>

<h3 id="ref">Ref</h3>

<p>Getting Started with Kubernetes provider</p>

<p><a href="https://www.terraform.io/docs/providers/kubernetes/guides/getting-started.html">https://www.terraform.io/docs/providers/kubernetes/guides/getting-started.html</a></p>
</div>
        <div class="post_footer">
          
          <div class="meta">
            <div class="info">
              <span class="field tags">
                <i class="remixicon-stack-line"></i>
                
                <a href="https://vsxen.github.io/tags/k8s/">k8s</a>
                
              </span>
            </div>
          </div>
          
        </div>
      </div>
      
      
    </div>
  </div>
  <a id="back_to_top" href="#" class="back_to_top"><span>△</span></a>
</div>
<div class="disqus">
  <div id="disqus_thread"></div>
<script type="application/javascript">
    var disqus_config = function () {
    
    
    
    };
    (function() {
        if (["localhost", "127.0.0.1"].indexOf(window.location.hostname) != -1) {
            document.getElementById('disqus_thread').innerHTML = 'Disqus comments not available by default when the website is previewed locally.';
            return;
        }
        var d = document, s = d.createElement('script'); s.async = true;
        s.src = '//' + "vsxen" + '.disqus.com/embed.js';
        s.setAttribute('data-timestamp', +new Date());
        (d.head || d.body).appendChild(s);
    })();
</script>
<noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
<a href="https://disqus.com" class="dsq-brlink">comments powered by <span class="logo-disqus">Disqus</span></a>
</div>
<footer class="footer">
  <div class="powered_by">
    <a href="https://zeuk.me">Designed by Zeuk,</a>
    <a href="http://www.gohugo.io/">Proudly published with Hugo</a>
  </div>

  <div class="footer_slogan">
    <span>Software Define Everything</span>
  </div>
</footer>



<script src="https://vsxen.github.io/js/jquery-3.3.1.min.js"></script>
<script src="https://vsxen.github.io/js/zozo.js"></script>
<script src="https://vsxen.github.io/js/highlight.pack.js"></script>
<link  href="https://vsxen.github.io/css/fancybox.min.css" rel="stylesheet">
<script src="https://vsxen.github.io/js/fancybox.min.js"></script>

<script>hljs.initHighlightingOnLoad()</script>




<script type="application/javascript">
var doNotTrack = false;
if (!doNotTrack) {
	window.ga=window.ga||function(){(ga.q=ga.q||[]).push(arguments)};ga.l=+new Date;
	ga('create', 'UA-81855844-3', 'auto');
	
	ga('send', 'pageview');
}
</script>
<script async src='https://www.google-analytics.com/analytics.js'></script>




</body>
</html>
