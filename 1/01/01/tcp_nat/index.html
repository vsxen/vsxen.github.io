<!DOCTYPE html>
<html lang="zh-cn" >
<head>
  <meta charset="utf-8"/>
  <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>

  
  <meta name="author"
        content="vsxen"/>

  
  <meta name="description" content="title: 从Nat到TCP_TW date: 2019-08-25T09:04:20&#43;08:00 draft: false toc: true tags: [&amp;quot;network&amp;quot;,&amp;quot;Linux&amp;quot;]  看到这个标题，你可能会感到疑惑这两个有什么关系呢？一个是IP转换一个是TCP，似乎关系不大？接下来听我慢慢介绍。
NAT 在IPV4的时代，IP可以分为两种，公网和局域网。当你在局域网时想要访问外面的内容就要经过Nat，即网络地址转换也就是把局域网的IP转换为公网，发送和接收请求。其中
 SNat 原地址转换 Source nat，也就是在发送请求的时候，我们的路由器把类似192.168.1.2转换为我们拨号上网的公网IP， DNat也就是目的地址转换，也就是在收到接收到请求的时候，把上面的公网IP转换为192.168.1.2的局域网IP。  也就是说其实我们无时无刻都在使用着Nat，这是客户端。对于服务端呢？也会用到Nat。典型的场景比如负载均衡。比如说我们请求的淘宝首页，淘宝的服务器肯定不止一台，淘宝可能也是通过负载均衡以及Nat来把请求分发到后端。
dig A taobao.com &#43;short 140.205.220.96 140.205.94.189  TCP 为什么会注意到这点呢？其实主要是因为部署在容器内的服务在连接MySQL的时候经常会报错比如：
pymysql.err.OperationalError: (2003, &amp;quot;Can&#39;t connect to MySQL server on &#39;xxxx (timed out)&amp;quot;) Error Code: 2013. Lost connection to MySQL server during query  主要的原因就是因为开发TCP timewait的复用。这里引用下别人的文章：
1. 同时开启tcp_timestamp和tcp_tw_recycle会启用TCP/IP协议栈的per-host的PAWS机制 2. 经过同一NAT转换后的来自不同真实client的数据流，在服务端看来是于同一host打交道 3. 虽然经过同一NAT转化，但由于不同真实client会携带各自的timestamp值 因而无法保证整过NAT转化后的数据包携带的timestamp值严格递增 4. 当服务器的per-host PAWS机制被触发后，会丢弃timestamp值不符合递增条件的数据包  先说结论
 开启tcp_timestamp，但不要开tcp_tw_recycle
 TCP的三次握手这些就不多说了，下面就根据流程图以及Linux kernel相关TCP参数补充一下细节。
客户端 服务端 &#43; &#43; | | | | Listen 监听端口 | | | | &#43;------------------------------------------------------------------&#43; 发送SYN,(SYN_SEND) | | | | | | 回复SYN&#43;ACK，到SYN_RCVD | | 回复ACK | | | | &#43;------------------------------------------------------------------&#43; 建立连接 建立链接 | | 建立链接 双方开始传输数据 | | 双方开始传输数据 | | GET / HTTP1."/>
  

  
  
  <meta name="keywords" content="blog, k8s, devops"/>
  

  
  <link rel="canonical" href="https://vsxen.github.io/1/01/01/tcp_nat/"/>

  

  <title> &middot; Code Life</title>

  <link rel="shortcut icon" href="https://vsxen.github.io/images/favicon.ico"/>
  <link rel="stylesheet" href="https://vsxen.github.io/css/animate.min.css"/>
  <link rel="stylesheet" href="https://vsxen.github.io/css/remixicon.css"/>
  <link rel="stylesheet" href="https://vsxen.github.io/css/zozo.css"/>
  <link rel="stylesheet" href="https://vsxen.github.io/css/highlight.css"/>

  
  

  <script>
    (function(d) {
      var config = {
        kitId: 'kfn1kkp',
        scriptTimeout: 3000,
        async: true
      },
      h=d.documentElement,t=setTimeout(function(){h.className=h.className.replace(/\bwf-loading\b/g,"")+" wf-inactive";},config.scriptTimeout),tk=d.createElement("script"),f=false,s=d.getElementsByTagName("script")[0],a;h.className+=" wf-loading";tk.src='https://use.typekit.net/'+config.kitId+'.js';tk.async=true;tk.onload=tk.onreadystatechange=function(){a=this.readyState;if(f||a&&a!="complete"&&a!="loaded")return;f=true;clearTimeout(t);try{Typekit.load(config)}catch(e){}};s.parentNode.insertBefore(tk,s)
    })(document);
  </script>
</head>

<body>
<div class="main animated">
  <div class="nav_container animated fadeInDown">
  <div class="site_nav" id="site_nav">
    <ul>
      
      <li>
        <a href="/">首页</a>
      </li>
      
      <li>
        <a href="/posts/">归档</a>
      </li>
      
      <li>
        <a href="/tags/">标签</a>
      </li>
      
      <li>
        <a href="/about/">关于</a>
      </li>
      
    </ul>
  </div>
  <div class="menu_icon">
    <a id="menu_icon"><i class="remixicon-links-line"></i></a>
  </div>
</div>

  <div class="header animated fadeInDown">
  <div class="site_title_container">
    <div class="site_title">
      <h1>
        <a href="https://vsxen.github.io">
          <span>Code Life</span>
          <img src="https://vsxen.github.io/images/logo.svg"/>
        </a>
      </h1>
    </div>
    <div class="description">
      <p class="sub_title">Life is too bug</p>
      <div class="my_socials">
        
        
        <a href="%20" title="facebook" target="_blank"><i class="remixicon-facebook-fill"></i></a>
        
        
        
        <a href="%20" title="github" target="_blank"><i class="remixicon-github-fill"></i></a>
        
        
        
        <a href="%20" title="instagram" target="_blank"><i class="remixicon-instagram-fill"></i></a>
        
        
        
        <a href="%20" title="twitter" target="_blank"><i class="remixicon-twitter-fill"></i></a>
        
        
        
        <a href="%20" title="weibo" target="_blank"><i class="remixicon-weibo-fill"></i></a>
        
        
        <a href="https://vsxen.github.io/index.xml" type="application/rss+xml" title="rss" target="_blank"><i class="remixicon-rss-fill"></i></a>
      </div>
    </div>
  </div>
</div>

  <div class="content">
    <div class="post_page">
      <div class="post animated fadeInDown">
        <div class="post_title post_detail_title">
          <h2><a href='/1/01/01/tcp_nat/'></a></h2>
          <span class="date">0001.01.01</span>
        </div>
        <div class="post_content markdown">

<pre><code>title: 从Nat到TCP_TW
date: 2019-08-25T09:04:20+08:00
draft: false
toc: true
tags: [&quot;network&quot;,&quot;Linux&quot;]
</code></pre>

<p>看到这个标题，你可能会感到疑惑这两个有什么关系呢？一个是IP转换一个是TCP，似乎关系不大？接下来听我慢慢介绍。</p>

<h3 id="nat">NAT</h3>

<p>在IPV4的时代，IP可以分为两种，公网和局域网。当你在局域网时想要访问外面的内容就要经过Nat，即网络地址转换也就是把局域网的IP转换为公网，发送和接收请求。其中</p>

<ul>
<li>SNat  原地址转换 Source nat，也就是在发送请求的时候，我们的路由器把类似192.168.1.2转换为我们拨号上网的公网IP，</li>
<li>DNat也就是目的地址转换，也就是在收到接收到请求的时候，把上面的公网IP转换为192.168.1.2的局域网IP。</li>
</ul>

<p>也就是说其实我们无时无刻都在使用着Nat，这是客户端。对于服务端呢？也会用到Nat。典型的场景比如负载均衡。比如说我们请求的淘宝首页，淘宝的服务器肯定不止一台，淘宝可能也是通过负载均衡以及Nat来把请求分发到后端。</p>

<pre><code class="language-bash">dig A taobao.com +short
140.205.220.96
140.205.94.189
</code></pre>

<h3 id="tcp">TCP</h3>

<p>为什么会注意到这点呢？其实主要是因为部署在容器内的服务在连接MySQL的时候经常会报错比如：</p>

<pre><code class="language-bash">pymysql.err.OperationalError: (2003, &quot;Can't connect to MySQL server on 'xxxx (timed out)&quot;)
Error Code: 2013. Lost connection to MySQL server during query
</code></pre>

<p>主要的原因就是因为开发TCP timewait的复用。这里引用下别人的文章：</p>

<pre><code class="language-bash">1. 同时开启tcp_timestamp和tcp_tw_recycle会启用TCP/IP协议栈的per-host的PAWS机制
2. 经过同一NAT转换后的来自不同真实client的数据流，在服务端看来是于同一host打交道
3. 虽然经过同一NAT转化，但由于不同真实client会携带各自的timestamp值
因而无法保证整过NAT转化后的数据包携带的timestamp值严格递增
4. 当服务器的per-host PAWS机制被触发后，会丢弃timestamp值不符合递增条件的数据包
</code></pre>

<p>先说结论</p>

<blockquote>
<p>开启tcp_timestamp，但不要开tcp_tw_recycle</p>
</blockquote>

<p>TCP的三次握手这些就不多说了，下面就根据流程图以及Linux kernel相关TCP参数补充一下细节。</p>

<pre><code class="language-bash">客户端                                            服务端
                  +                          +
                  |                          |
                  |                          |   Listen 监听端口
                  |                          |
                  |                          |
+------------------------------------------------------------------+
发送SYN,(SYN_SEND) |                          |
                  |                          |   
                  |                          |  回复SYN+ACK，到SYN_RCVD
                  |                          |
 回复ACK           |                          |
                  |                          |
+------------------------------------------------------------------+                                            建立连接
 建立链接          |                          | 建立链接
 双方开始传输数据   |                          | 双方开始传输数据
                  |                          |  
  GET / HTTP1.1   |                          |                  
                  |                          |  
                  |                          |   ESTABLISHED              
+------------------------------------------------------------------+                                 
发FIN (FIN_WAIT1) |                          | 
                  |                          | 
                  |                          | ACK
                  |                          | (CLOSE_WAIT)
 (FIN_WAIT2)      |                          | 
                  |                          | 发FIN+ACK
                  |                          | (LAST_ACK)              
                  |                          |
 发ACK            |                          |
 (TIME_WAIT)      |                          | 
                  |                          |      
 2MSL之后CLOSED    |                          | CLOSED
                  +                          +

</code></pre>

<p>Kernel中关于TCP的可设置项目，这里我们可以看到time timeout的时间我们是不能设置的，只能设置tcp_fin_timeout默认值是60。</p>

<pre><code class="language-bash">sysctl -a |grep tcp
net.ipv4.tcp_abort_on_overflow = 0
net.ipv4.tcp_adv_win_scale = 1
net.ipv4.tcp_allowed_congestion_control = reno cubic
net.ipv4.tcp_app_win = 31
net.ipv4.tcp_autocorking = 1
net.ipv4.tcp_available_congestion_control = reno cubic
net.ipv4.tcp_available_ulp =
net.ipv4.tcp_base_mss = 1024
net.ipv4.tcp_challenge_ack_limit = 1000
net.ipv4.tcp_congestion_control = cubic
net.ipv4.tcp_dsack = 1
net.ipv4.tcp_early_demux = 1
net.ipv4.tcp_early_retrans = 3
net.ipv4.tcp_ecn = 2
net.ipv4.tcp_ecn_fallback = 1
net.ipv4.tcp_fack = 0
net.ipv4.tcp_fastopen = 1
net.ipv4.tcp_fastopen_blackhole_timeout_sec = 3600
net.ipv4.tcp_fastopen_key = 00000000-00000000-00000000-00000000
net.ipv4.tcp_fin_timeout = 60
net.ipv4.tcp_frto = 2
net.ipv4.tcp_fwmark_accept = 0
net.ipv4.tcp_invalid_ratelimit = 500
net.ipv4.tcp_keepalive_intvl = 75
net.ipv4.tcp_keepalive_probes = 9
net.ipv4.tcp_keepalive_time = 7200
net.ipv4.tcp_l3mdev_accept = 0
net.ipv4.tcp_limit_output_bytes = 262144
net.ipv4.tcp_low_latency = 0
sysctl: reading key &quot;net.ipv6.conf.all.stable_secret&quot;
net.ipv4.tcp_max_orphans = 16384
net.ipv4.tcp_max_reordering = 300
net.ipv4.tcp_max_syn_backlog = 128
net.ipv4.tcp_max_tw_buckets = 16384
net.ipv4.tcp_mem = 45840        61122   91680
net.ipv4.tcp_min_rtt_wlen = 300
net.ipv4.tcp_min_snd_mss = 48
net.ipv4.tcp_min_tso_segs = 2
net.ipv4.tcp_moderate_rcvbuf = 1
net.ipv4.tcp_mtu_probing = 0
net.ipv4.tcp_no_metrics_save = 0
net.ipv4.tcp_notsent_lowat = 4294967295
net.ipv4.tcp_orphan_retries = 0
net.ipv4.tcp_pacing_ca_ratio = 120
net.ipv4.tcp_pacing_ss_ratio = 200
net.ipv4.tcp_probe_interval = 600
net.ipv4.tcp_probe_threshold = 8
net.ipv4.tcp_recovery = 1
net.ipv4.tcp_reordering = 3
net.ipv4.tcp_retrans_collapse = 1
net.ipv4.tcp_retries1 = 3
net.ipv4.tcp_retries2 = 15
net.ipv4.tcp_rfc1337 = 0
net.ipv4.tcp_rmem = 4096        131072  6291456
net.ipv4.tcp_sack = 1
net.ipv4.tcp_slow_start_after_idle = 1
net.ipv4.tcp_stdurg = 0
net.ipv4.tcp_syn_retries = 6
net.ipv4.tcp_synack_retries = 5
net.ipv4.tcp_syncookies = 1
net.ipv4.tcp_thin_linear_timeouts = 0
net.ipv4.tcp_timestamps = 1
net.ipv4.tcp_tso_win_divisor = 3
net.ipv4.tcp_tw_reuse = 2
net.ipv4.tcp_window_scaling = 1
net.ipv4.tcp_wmem = 4096        16384   4194304
net.ipv4.tcp_workaround_signed_windows = 0
sysctl: reading key &quot;net.ipv6.conf.default.stable_secret&quot;
sysctl: reading key &quot;net.ipv6.conf.docker0.stable_secret&quot;
sysctl: reading key &quot;net.ipv6.conf.docker_gwbridge.stable_secret&quot;
sysctl: reading key &quot;net.ipv6.conf.enp0s3.stable_secret&quot;
sysctl: reading key &quot;net.ipv6.conf.enp0s8.stable_secret&quot;
sysctl: reading key &quot;net.ipv6.conf.lo.stable_secret&quot;
sysctl: reading key &quot;net.ipv6.conf.veth2465cce.stable_secret&quot;
net.netfilter.nf_conntrack_tcp_be_liberal = 0
net.netfilter.nf_conntrack_tcp_loose = 1
net.netfilter.nf_conntrack_tcp_max_retrans = 3
net.netfilter.nf_conntrack_tcp_timeout_close = 10
net.netfilter.nf_conntrack_tcp_timeout_close_wait = 60
net.netfilter.nf_conntrack_tcp_timeout_established = 432000
net.netfilter.nf_conntrack_tcp_timeout_fin_wait = 120
net.netfilter.nf_conntrack_tcp_timeout_last_ack = 30
net.netfilter.nf_conntrack_tcp_timeout_max_retrans = 300
net.netfilter.nf_conntrack_tcp_timeout_syn_recv = 60
net.netfilter.nf_conntrack_tcp_timeout_syn_sent = 120
net.netfilter.nf_conntrack_tcp_timeout_time_wait = 120
net.netfilter.nf_conntrack_tcp_timeout_unacknowledged = 300
root@ubuntu-bionic:/home/vagrant# uname  -a
Linux ubuntu-bionic 4.15.0-96-generic #97-Ubuntu SMP Wed Apr 1 03:25:46 UTC 2020 x86_64 x86_64 x86_64 GNU/Linux
</code></pre>

<p><img src="../../images/tcpdump.png" alt="image-20191229135452187" /></p>

<h3 id="ref">Ref</h3>

<p><a href="https://www.kernel.org/doc/Documentation/networking/ip-sysctl.txt">https://www.kernel.org/doc/Documentation/networking/ip-sysctl.txt</a></p>

<p><a href="http://perthcharles.github.io/2015/08/27/timestamp-intro/">http://perthcharles.github.io/2015/08/27/timestamp-intro/</a></p>

<p><a href="https://yuanrengu.com/2020/77eef79f.html">https://yuanrengu.com/2020/77eef79f.html</a></p>
</div>
        <div class="post_footer">
          
        </div>
      </div>
      
      
    </div>
  </div>
  <a id="back_to_top" href="#" class="back_to_top"><span>△</span></a>
</div>
<div class="disqus">
  <div id="disqus_thread"></div>
<script type="application/javascript">
    var disqus_config = function () {
    
    
    
    };
    (function() {
        if (["localhost", "127.0.0.1"].indexOf(window.location.hostname) != -1) {
            document.getElementById('disqus_thread').innerHTML = 'Disqus comments not available by default when the website is previewed locally.';
            return;
        }
        var d = document, s = d.createElement('script'); s.async = true;
        s.src = '//' + "vsxen" + '.disqus.com/embed.js';
        s.setAttribute('data-timestamp', +new Date());
        (d.head || d.body).appendChild(s);
    })();
</script>
<noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
<a href="https://disqus.com" class="dsq-brlink">comments powered by <span class="logo-disqus">Disqus</span></a>
</div>
<footer class="footer">
  <div class="powered_by">
    <a href="https://zeuk.me">Designed by Zeuk,</a>
    <a href="http://www.gohugo.io/">Proudly published with Hugo</a>
  </div>

  <div class="footer_slogan">
    <span>Software Define Everything</span>
  </div>
</footer>



<script src="https://vsxen.github.io/js/jquery-3.3.1.min.js"></script>
<script src="https://vsxen.github.io/js/zozo.js"></script>
<script src="https://vsxen.github.io/js/highlight.pack.js"></script>
<link  href="https://vsxen.github.io/css/fancybox.min.css" rel="stylesheet">
<script src="https://vsxen.github.io/js/fancybox.min.js"></script>

<script>hljs.initHighlightingOnLoad()</script>




<script type="application/javascript">
var doNotTrack = false;
if (!doNotTrack) {
	window.ga=window.ga||function(){(ga.q=ga.q||[]).push(arguments)};ga.l=+new Date;
	ga('create', 'UA-81855844-3', 'auto');
	
	ga('send', 'pageview');
}
</script>
<script async src='https://www.google-analytics.com/analytics.js'></script>




</body>
</html>
